metadata:
  type: "governance"
  name: "LEAP Safety & Continuity Protocol"
  purpose: "Mandatory backup and deployment safety rules for AI Agents"
  version: "1.0.0"
  created: "2026-01-15"
  lastUpdated: "2026-01-15"
  status: "mandatory"

lifecycle:
  currentStage: "delivery"
  status: "complete"
  nextStage: "N/A (living document)"

humanInterface:
  checkpointRequired: false
  context: "Mandatory for all AI Agents assisting with LEAP project"

rules:
  
  stageBasedBackups:
    name: "Stage-Based Backup Policy"
    rule: "Create backups at lifecycle stage transitions, not arbitrary time intervals"
    location: "./backups/ (inside project, git-ignored)"
    namingConvention: "LEAP-v[VERSION]-[TOPIC]"
    example: "LEAP-v6.8.0-phase-20-complete"
    enforcement: "Mandatory"
    
    mandatoryBackups:
      - stage: "design → implementation"
        when: "Before starting code changes"
        reason: "Stable state before implementation - can rollback if implementation fails"
        example: "LEAP-v6.9.0-pre-phase-21"
        required: true
        note: "This is the PRIMARY backup for the phase - create before ANY code changes"
        clarification: "Backup before first file modification in implementation stage"
      
      - stage: "validation → delivery"
        when: "After testing passes, phase complete"
        reason: "Major milestone, working and tested state, deployable"
        example: "LEAP-v6.9.0-phase-21-complete"
        required: true
        note: "This is the COMPLETION backup - create after validation succeeds"
        clarification: "Only create if validation passed - this is the 'known good' state"
      
      - stage: "Before Core File Refactor"
        when: "Before modifying app.js, index.html, vite.config.js, firebase.js, state-manager.js"
        reason: "Safety net for architectural changes"
        required: true
        note: "If not already backed up in this phase"
        addedDate: "2026-01-16"
        source: "Phase 21.2c - GOV-005"
        
        coreFiles:
          - "app.js (main orchestrator)"
          - "index.html (entry point)"
          - "vite.config.js (build configuration)"
          - "firebase.js (database connection)"
          - "state-manager.js (application state)"
        
        edgeCases:
          - scenario: "Already created design→implementation backup, now need to refactor core file mid-phase"
            action: "Create additional backup before core file changes"
            naming: "LEAP-v6.9.0-pre-core-refactor"
            rationale: "Core file changes are high-risk, deserve dedicated backup"
          
          - scenario: "Multiple core files to refactor in same phase"
            action: "One backup before first core file change is sufficient"
            rationale: "Don't create backup for each core file, just before touching any core files"
          
          - scenario: "Unsure if file counts as 'core'"
            action: "If file is critical to app startup or data flow, treat as core and create backup"
            guideline: "When in doubt, create backup - better safe than sorry"
        
        rule: "Minimum one backup per phase. Additional backup if touching core files mid-phase (unless already backed up before core changes)."
      
      - stage: "Before Deployment"
        when: "Before pushing to main or deploying to production"
        reason: "Ensure working state is preserved"
        required: true
        note: "Even if other backups exist, create pre-deployment backup for safety"
        clarification: "This protects against deployment issues - always create before deploy"
    
    optionalBackups:
      - when: "Mid-implementation if risky"
        reason: "Extra safety for complex changes"
      
      - when: "After major feature complete"
        reason: "Significant milestone"
  
  deploymentSafety:
    name: "Deployment Safety"
    rule: "Never push new build to main branch without verifying it works locally or on experimental branch first"
    verification: "Use browser_subagent to verify deployment on GitHub Pages every time v[x] bump occurs"
    enforcement: "Mandatory"

backupWorkflow:
  purpose: "For AI Agents executing backups"
  location: "./backups/ (inside project, git-ignored)"
  
  command: |
    # Stage-based backup command (updated 2026-01-16 for scope restriction)
    mkdir -p ./backups/LEAP-v[VERSION]-[TOPIC]
    rsync -av --exclude='backups/' --exclude='node_modules/' --exclude='dist/' --exclude='.git/' . ./backups/LEAP-v[VERSION]-[TOPIC]/
  
  steps:
    - "Identify current version and topic (e.g., v6.9.0-pre-phase-21)"
    - "Create directory inside project: ./backups/LEAP-v[VERSION]-[TOPIC]/"
    - "Copy entire project (includes src/, docs/, all files)"
    - "Verify backup is complete"
    - "Report backup location to user"
  
  gitCommit:
    purpose: "Git is primary version control"
    rule: "Always commit changes to git in addition to backups"
    when: "After significant work, before backups"
  
  notes:
    - "Backups are snapshots at major milestones"
    - "Git commits provide continuous version control"
    - "Backups stored in ./backups/ (git-ignored, inside project)"
    - "Policy updated 2026-01-16: moved from ../ to ./backups/ for Antigravity scope compliance"

