# =============================================================================
# FUNCTIONAL SPEC: NEXUS AI Workbench
# =============================================================================
# Source: DISCO-001 Discovery Lab (Form Evolution Pattern)
# Purpose: AI-Native workbench for conversational record editing
# Updated: 2026-01-25 - Aligned with GoldSource standards
# =============================================================================

metadata:
  specId: "NEXUS-WORKBENCH"
  name: "NEXUS AI Workbench"
  version: "3.0.0"
  created: "2026-01-23"
  updated: "2026-01-25"
  status: "locked"
  lockedAt: "2026-01-25T23:55:00Z"
  discoveryRef: "DISCO-001_Extensible_AI_Form_Evolution"
  goldSourceAlignment: "v2.0"

# =============================================================================
# REFERENCE IMPLEMENTATION
# =============================================================================

referenceImplementation:
  prototype: "T-1_Spec/reference_workbench.html"
  prototypeVersion: "v3.0"
  
  prototypeRole: |
    This is a VISUAL CONTRACT only. The HTML demonstrates exact layout,
    styling, and animations. Implementation must use GoldSource patterns.
    
    IS:  Visual/behavioral reference - "match this exactly"
    IS:  Source of truth for colors, spacing, layouts, animations
    IS:  JavaScript API contract (window.NEXUS methods)
    IS:  Uses GoldSource design tokens (variables.css aligned)
    
    IS NOT: Copy-paste code source
    IS NOT: Architecture reference (prototype is monolithic)

  devAgentGuidance:
    - "Match prototype visuals exactly using GoldSource patterns"
    - "Use CSS variables from variables.css - DO NOT redefine tokens"
    - "Implement as modular components (*-ui.js + *.css)"
    - "Add AI-First headers to all new files"
    - "Window.NEXUS API must be preserved for directive integration"
    - "Modal must overlay header/sidebar (z-index: --z-modal)"

# =============================================================================
# GOLDSOURCE TOKEN MAPPING
# =============================================================================

goldSourceTokens:
  description: "This spec uses GoldSource v2.0 tokens from variables.css"
  
  colors:
    background: "--bg-primary"
    accent: "--accent-primary"
    accentGlow: "--accent-glow"
    textPrimary: "--text-primary"
    textSecondary: "--text-secondary"
    textTertiary: "--text-tertiary (new - add to variables.css)"
    semantic:
      success: "--success"
      error: "--error"
      warning: "--warning"
      info: "--info"
  
  glass:
    background: "--glass-bg"
    backgroundHeavy: "--glass-bg-heavy (workbench-specific)"
    border: "--glass-border"
    blur: "--glass-blur"
    shadow: "--glass-shadow"
  
  spacing:
    xs: "--space-xs"
    sm: "--space-sm"
    md: "--space-md"
    lg: "--space-lg"
    xl: "--space-xl"
  
  radius:
    sm: "--radius-sm"
    md: "--radius-md"
    lg: "--radius-lg"
    full: "--radius-full"
  
  transitions:
    fast: "--transition-fast"
    normal: "--transition-normal"
    slow: "--transition-slow"
    spring: "--spring (workbench-specific easing)"
  
  zIndex:
    modalBackdrop: "--z-modal-backdrop (300)"
    modal: "--z-modal (400)"
  
  typography:
    fontHeading: "--font-heading"
    fontBody: "--font-body"

# =============================================================================
# INTEGRATION
# =============================================================================

integration:
  trigger:
    location: "My Work dashboard only"
    action: "Click on any card"
    handler: "card-service.js should emit event or call NEXUS.openWorkbench()"
  
  positioning:
    type: "modal-overlay"
    overlapsShell: true
    overlapsHeader: true
    overlapsSidebar: true
    backdropBlur: "8px"
    zIndex: "--z-modal (400)"
  
  stateManagement:
    approach: "Stateless modal - no registerStateSlice needed"
    reason: "Workbench fetches record data on open, doesn't persist"
  
  closeActions:
    - "Click close button (X)"
    - "Click backdrop (outside workbench)"
    - "Press Escape key"
  
  accessibility:
    focusTrap: true
    initialFocus: "Close button"
    escapeToClose: true

# =============================================================================
# LAYOUT STRUCTURE
# =============================================================================

layout:
  container:
    width: "90vw"
    maxWidth: "1400px"
    height: "85vh"
    maxHeight: "900px"
    centered: true
  
  structure:
    - segment: "TOP_BAR"
      span: "full-width"
      rows:
        - row: 1
          content: "[Record ID] [Short Description]"
        - row: 2
          content: "[Status][P][I][U] | [Group] â€º [Assignee]"
    
    - segment: "MAIN_CONTENT"
      split: "50:50"
      left: "AI_CHAT_PANE"
      right: "DYNAMIC_FIELDS_PANE"

  panes:
    AI_CHAT_PANE:
      sections:
        - "Chat stream (scrollable)"
        - "Input area (fixed bottom): [â€¢Brand] [Input] [ðŸ“‚][ðŸŽ¤][â†’]"
    
    DYNAMIC_FIELDS_PANE:
      sections:
        - "Section: Context (default visible)"
        - "Section: Location (hidden, AI-revealed)"
        - "Section: Detail (hidden, AI-revealed)"
        - "Section: Proposal (hidden, AI-revealed)"
        - "Action Tray (floating bottom, hidden until proposal)"

# =============================================================================
# THEME SYSTEM
# =============================================================================

themeSystem:
  detection: ".light-theme class on body (GoldSource standard)"
  
  tokens:
    dark:
      # Uses :root defaults from variables.css
      note: "Dark is default - no class needed"
    
    light:
      # Uses .light-theme overrides from variables.css
      note: "Applied via document.body.classList.add('light-theme')"

  typography:
    headings: "var(--font-heading) (Outfit)"
    body: "var(--font-body) (Inter)"

# =============================================================================
# COMPONENT SPECIFICATIONS
# =============================================================================

components:

  # --- Modal Backdrop ---
  modalBackdrop:
    selector: ".workbench-backdrop"
    behavior:
      default: "Hidden, opacity 0"
      open: "Visible, opacity 1, blur overlay"
    cssVariables:
      zIndex: "--z-modal-backdrop (300)"
      blur: "8px"
      background: "rgba(0, 0, 0, 0.6)"

  # --- Close Button ---
  closeButton:
    selector: ".btn-close"
    behavior:
      default: "Transparent with glass border"
      hover:
        - "Background: rgba(239,68,68,0.15)"
        - "Color: var(--error)"
        - "Icon rotates 90Â°"
        - "Scale: 1.08"
      active: "Scale: 0.92"
    transition: "var(--transition-fast)"

  # --- Pills ---
  pills:
    status:
      class: ".pill--status"
      style: "Solid background, rounded rectangle"
    metric:
      class: ".pill--metric"
      style: "Dull/low-contrast by default"
      highlight: "Accent glow when changed by AI"
    assignment:
      class: ".pill--assignment"
      style: "Rounded pill, connected with chain-sep"

  # --- Chat Messages ---
  chatMessages:
    ai:
      class: ".msg--ai"
      style: "Left-aligned, glass border, muted text"
    human:
      class: ".msg--human"
      style: "Right-aligned, accent border, primary text"
    animation: "Slide-in from left (var(--transition-normal))"

  # --- Field Pills (Dynamic Area) ---
  fieldPills:
    class: ".field-pill"
    sizes:
      quarter: "25% width (4 per row)"
      third: "33% width (3 per row)"
      half: "50% width (2 per row)"
      full: "100% width (1 per row)"
    ghost:
      class: ".field-pill--ghost"
      style: "Accent glow, accent text (AI proposal)"
    animation: "Fade-in from bottom (var(--transition-normal))"

  # --- Action Tray ---
  actionTray:
    position: "Absolute, bottom var(--space-lg), centered"
    buttons:
      primary: "Accent gradient, dark text, shadow"
      secondary: "Glass background, muted text"
    visibility: "Hidden until showActionTray(true)"

# =============================================================================
# ANIMATIONS
# =============================================================================

animations:
  bloomOpen:
    trigger: "openWorkbench(originX, originY)"
    duration: "600ms"
    easing: "var(--spring) (0.19, 1, 0.22, 1)"
    properties:
      - "opacity: 0 â†’ 1"
      - "scale: 0.3 â†’ 1"
      - "filter: blur(10px) â†’ blur(0)"
    transformOrigin: "Dynamic (from click position %)"

  bloomClose:
    trigger: "closeWorkbench() or btn-close click or ESC"
    duration: "500ms"
    easing: "ease-out"
    properties:
      - "opacity: 1 â†’ 0"
      - "scale: 1 â†’ 0.2"
      - "filter: blur(0) â†’ blur(15px)"

  messageIn:
    trigger: "addMessage()"
    duration: "var(--transition-normal)"
    easing: "ease-out"
    properties: "translateX(-5px) â†’ 0, opacity: 0 â†’ 1"

  pillIn:
    trigger: "renderSection()"
    duration: "var(--transition-normal)"
    easing: "ease-out"
    properties: "translateY(5px) â†’ 0, opacity: 0 â†’ 1"
    stagger: "50ms per pill"

# =============================================================================
# JAVASCRIPT API (window.NEXUS)
# =============================================================================

jsApi:
  namespace: "window.NEXUS"
  
  methods:
    - name: "openWorkbench"
      signature: "openWorkbench(originX: number, originY: number)"
      description: "Opens workbench with bloom animation from origin %"
      note: "originX/Y should be calculated from click event position"
    
    - name: "closeWorkbench"
      signature: "closeWorkbench()"
      description: "Closes workbench with reverse bloom animation"
    
    - name: "setField"
      signature: "setField(name: string, value: string)"
      description: "Populates element with data-field='name'"
    
    - name: "highlightField"
      signature: "highlightField(name: string, highlight: boolean)"
      description: "Toggles .highlight class on metric pill"
    
    - name: "renderSection"
      signature: "renderSection(name: string, fields: Field[])"
      description: "Renders dynamic pill grid for named section"
      fieldSchema: |
        Field {
          label: string
          value: string
          size: 'quarter' | 'third' | 'half' | 'full'
          ghost?: boolean
          large?: boolean
        }
    
    - name: "showActionTray"
      signature: "showActionTray(show: boolean)"
      description: "Shows/hides floating approval buttons"
    
    - name: "addMessage"
      signature: "addMessage(role: 'ai' | 'human', text: string)"
      description: "Appends chat message with animation"

# =============================================================================
# DATA BINDING
# =============================================================================

dataBinding:
  topBar:
    - field: "number"
      element: "[data-field='number']"
    - field: "short_description"
      element: "[data-field='short_description']"
    - field: "state"
      element: "[data-field='state']"
    - field: "priority"
      element: "[data-field='priority']"
      highlightable: true
    - field: "impact"
      element: "[data-field='impact']"
      highlightable: true
    - field: "urgency"
      element: "[data-field='urgency']"
      highlightable: true
    - field: "assignment_group"
      element: "[data-field='assignment_group']"
    - field: "assigned_to"
      element: "[data-field='assigned_to']"

  dynamicSections:
    - name: "context"
      display: "Context"
      defaultVisible: true
    - name: "location"
      display: "Location"
      defaultVisible: false
    - name: "detail"
      display: "Detail"
      defaultVisible: false
    - name: "proposal"
      display: "Proposal"
      defaultVisible: false

# =============================================================================
# ACCESSIBILITY
# =============================================================================

accessibility:
  requirements:
    - "All interactive elements have aria-labels"
    - "Focus trap within workbench when open"
    - "ESC key closes workbench"
    - "Tab navigation through chat and fields"
    - "Screen reader announces new messages"
    - "Initial focus moved to close button on open"
    - "Click outside workbench closes it"

# =============================================================================
# IMPLEMENTATION CHECKLIST
# =============================================================================

implementationChecklist:
  - task: "Create component folder structure"
    files:
      - "ui/components/workbench/workbench-ui.js"
      - "ui/components/workbench/workbench.css"
  
  - task: "Add workbench-specific tokens to variables.css"
    acceptance: "Add to :root AND .light-theme sections"
  
  - task: "Implement modal backdrop"
    acceptance: "Covers full screen, z-index above header/sidebar"
  
  - task: "Implement layout shell"
    acceptance: "Matches prototype dimensions with 50:50 split"
  
  - task: "Implement close button"
    acceptance: "Hover rotates icon, active scales down"
  
  - task: "Implement bloom animations"
    acceptance: "Open/close animate from/to click origin point"
  
  - task: "Implement chat pane"
    acceptance: "Messages append with animation, input styled"
  
  - task: "Implement dynamic fields pane"
    acceptance: "Sections hide/show, pills wrap, ghost styling works"
  
  - task: "Expose NEXUS API"
    acceptance: "All window.NEXUS methods functional"
  
  - task: "Integrate with canvas-ui.js"
    acceptance: "Clicking card on My Work triggers openWorkbench()"
  
  - task: "Accessibility audit"
    acceptance: "ESC close, focus trap, aria-labels"

# =============================================================================
# MODULE CONTRACT TEMPLATE (REQUIRED)
# =============================================================================

moduleContract:
  description: "All new JS files MUST start with this header format"
  
  workbenchUiJs: |
    /**
     * @file workbench-ui.js
     * @purpose NEXUS AI Workbench - Modal overlay for conversational record editing
     * @spec DISCO-001 / SPEC-NEXUS-workbench.yaml v3.0
     * @layer ui-component
     * @dependencies [state.js, logger.js]
     * @dependents [canvas-ui.js]
     * @modifyImpact [modal overlay, NEXUS API]
     */

# =============================================================================
# IMPORT PATHS (CRITICAL - Prevents 404 errors)
# =============================================================================

importPaths:
  description: "Exact import statements for workbench-ui.js"
  depth: 3  # ui/components/workbench/ is 3 levels deep
  
  required:
    - statement: "import { log } from '../../../core/logger.js';"
      purpose: "Logging"
    - statement: "import { StateManager } from '../../../core/state.js';"
      purpose: "State subscription (optional for this component)"
  
  note: |
    Path depth from ui/components/workbench/:
    - To core/ = ../../../core/
    - To features/ = ../../../features/

# =============================================================================
# TOKENS TO ADD TO VARIABLES.CSS (REQUIRED)
# =============================================================================

tokensToAdd:
  description: "Add these tokens to 2_GoldSource/scaffold/ui/styles/variables.css"
  
  darkTheme:
    section: ":root { }"
    tokens:
      - name: "--text-tertiary"
        value: "#4b5563"
        purpose: "Low-contrast text (labels, separators)"
      - name: "--glass-bg-heavy"
        value: "rgba(13, 17, 23, 0.92)"
        purpose: "Modal background (higher opacity than glass-bg)"
      - name: "--pill-bg"
        value: "rgba(255, 255, 255, 0.04)"
        purpose: "Subtle pill/badge background"
      - name: "--spring"
        value: "cubic-bezier(0.19, 1, 0.22, 1)"
        purpose: "Bloom animation easing"
  
  lightTheme:
    section: ".light-theme { }"
    tokens:
      - name: "--text-tertiary"
        value: "#94a3b8"
      - name: "--glass-bg-heavy"
        value: "rgba(255, 255, 255, 0.95)"
      - name: "--pill-bg"
        value: "rgba(0, 0, 0, 0.03)"

# =============================================================================
# CARD INTEGRATION CODE (CRITICAL - Without this, workbench can't open)
# =============================================================================

cardIntegration:
  description: |
    This code must be added to canvas-ui.js to enable card clicks to open workbench.
    The workbench-ui.js exposes window.NEXUS, and canvas-ui.js calls it when a card is clicked.
  
  targetFile: "ui/components/canvas/canvas-ui.js"
  
  step1_importWorkbench:
    description: "Import workbench at top of canvas-ui.js"
    code: |
      // Add this import at top of file (after existing imports)
      import '../workbench/workbench-ui.js';
  
  step2_addClickHandler:
    description: "Add click handler to card elements during render"
    location: "Inside the function that creates/renders card elements"
    code: |
      // Add this to each card element after creation:
      cardElement.addEventListener('click', (e) => {
          // Only trigger if not clicking a button/link inside the card
          if (e.target.closest('button, a, .card-action')) return;
          
          // Calculate bloom origin from click position
          const originX = (e.clientX / window.innerWidth) * 100;
          const originY = (e.clientY / window.innerHeight) * 100;
          
          // Open workbench with card data
          if (window.NEXUS && window.NEXUS.openWorkbench) {
              window.NEXUS.openWorkbench(originX, originY);
              
              // Populate with card data
              window.NEXUS.setField('number', cardData.id);
              window.NEXUS.setField('short_description', cardData.title);
              window.NEXUS.setField('state', cardData.horizon);
              window.NEXUS.setField('priority', cardData.priority);
              window.NEXUS.setField('impact', cardData.impact || 'Medium');
              window.NEXUS.setField('urgency', cardData.urgency || 'Medium');
              window.NEXUS.setField('assignment_group', cardData.group || 'Unassigned');
              window.NEXUS.setField('assigned_to', cardData.assignee || 'Unassigned');
              
              // Render context section
              window.NEXUS.renderSection('context', [
                  { label: 'Category', value: cardData.category || 'Incident', size: 'third' },
                  { label: 'Horizon', value: cardData.horizon, size: 'third' },
                  { label: 'Priority', value: cardData.priority, size: 'third' },
                  { label: 'Description', value: cardData.description || cardData.title, size: 'full', large: true }
              ]);
              
              // Add initial AI message
              window.NEXUS.addMessage('ai', `I see you're viewing ${cardData.id}. How can I help with this ${cardData.priority} item?`);
          }
      });
  
  step3_cursorStyle:
    description: "Add cursor pointer to indicate cards are clickable"
    location: "canvas.css or card.css"
    code: |
      .card {
          cursor: pointer;
      }
      .card:hover {
          /* existing hover styles */
      }

# =============================================================================
# INDEX.HTML ADDITIONS (REQUIRED)
# =============================================================================

indexHtmlAdditions:
  description: "Add these elements to index.html"
  
  cssLink:
    location: "In <head>, after other component CSS links"
    code: |
      <link rel="stylesheet" href="scaffold/ui/components/workbench/workbench.css">
  
  jsModule:
    location: "workbench-ui.js is imported by canvas-ui.js, no separate script tag needed"
  
  htmlSlot:
    location: "At end of <body>, before closing </body> tag"
    code: |
      <!-- NEXUS Workbench Modal (rendered by workbench-ui.js) -->
      <div id="workbench-root"></div>
