# Stage T-3: Analysis & Risk
# DISCO-002: NEXUS Integration Layer

stage:
  id: "T-3"
  name: "Analysis & Risk"
  status: "complete"
  completedAt: "2026-01-23T11:35:58Z"

# =============================================================================
# FAILURE MODES
# =============================================================================

failureModes:
  - id: "FM-001"
    name: "Adapter Unavailable"
    scenario: "MCP server or SoR adapter is not running/reachable"
    impact: "User cannot send intents or receive updates"
    mitigation: "Graceful error state in NEXUS UI with 'Reconnect' option"
    severity: "high"

  - id: "FM-002"
    name: "Event Ordering"
    scenario: "Events arrive out of order (activity.update before activity.new)"
    impact: "NEXUS may try to update a card that doesn't exist"
    mitigation: "Queue events; process activity.new first; discard orphaned updates"
    severity: "medium"

  - id: "FM-003"
    name: "Stale Proposals"
    scenario: "AI proposes change, but SoR field was already updated by another user"
    impact: "User approves outdated proposal, overwriting newer data"
    mitigation: "Include version/timestamp in proposals; validate before commit"
    severity: "high"

  - id: "FM-004"
    name: "Large Batch Conflict"
    scenario: "User approves batch of 10 proposals; 3 fail due to SoR validation"
    impact: "Partial commit, inconsistent state"
    mitigation: |
      Option A: All-or-nothing transaction (reject entire batch if any fail)
      Option B: Show per-field success/failure, let user retry failed ones
    severity: "medium"
    decision: "TBD - needs user input"

  - id: "FM-005"
    name: "Duplicate Activity Cards"
    scenario: "SoR sends activity.new for same record twice"
    impact: "Two cards for same incident on canvas"
    mitigation: "NEXUS de-duplicates by activityId; update existing card instead"
    severity: "low"

  - id: "FM-006"
    name: "Chat History Sync"
    scenario: "User opens same card on two devices; chat histories diverge"
    impact: "Inconsistent conversation context"
    mitigation: "Firebase real-time sync handles this (by design)"
    severity: "low"

  - id: "FM-007"
    name: "Adapter Translation Error"
    scenario: "Adapter fails to parse SoR response or map fields correctly"
    impact: "Missing or incorrect data in NEXUS"
    mitigation: "Adapter must validate and log errors; NEXUS shows 'data unavailable' for missing fields"
    severity: "medium"

  - id: "FM-008"
    name: "Authentication Expiry"
    scenario: "OAuth token expires mid-session"
    impact: "SoR calls fail silently or with cryptic errors"
    mitigation: "Adapter must handle token refresh; surface auth errors to user"
    severity: "medium"

# =============================================================================
# EDGE CASES
# =============================================================================

edgeCases:
  - id: "EC-001"
    name: "Empty Canvas"
    scenario: "User has no active cards"
    expected: "Show onboarding state or 'No active work' message"

  - id: "EC-002"
    name: "Card Limit"
    scenario: "User has 100+ active cards"
    expected: "Pagination or virtualized list; consider archival workflow"

  - id: "EC-003"
    name: "Very Long Conversation"
    scenario: "Chat history exceeds 1000 messages"
    expected: "Truncate older messages in UI; keep full history in Firebase"

  - id: "EC-004"
    name: "Multi-Language Fields"
    scenario: "SoR returns field values in different languages"
    expected: "NEXUS displays as-is; no translation layer"

  - id: "EC-005"
    name: "Binary/Rich Content"
    scenario: "Field contains image, file, or formatted HTML"
    expected: "Phase 1: Display as link/placeholder. Future: Rich rendering"

  - id: "EC-006"
    name: "Rapid Updates"
    scenario: "SoR sends 10 activity.update events in 1 second"
    expected: "Debounce UI updates; batch visual refreshes"

# =============================================================================
# RISKS
# =============================================================================

risks:
  - id: "R-001"
    name: "Adapter Complexity"
    description: "Each SoR requires significant adapter development"
    likelihood: "high"
    impact: "medium"
    mitigation: "Start with ServiceNow only; design adapter interface for extensibility"

  - id: "R-002"
    name: "Firebase Costs"
    description: "High volume of cards/messages could spike Firebase costs"
    likelihood: "low"
    impact: "medium"
    mitigation: "Monitor usage; implement archival for old cards"

  - id: "R-003"
    name: "AI Hallucination"
    description: "AI proposes changes to fields that don't exist or with invalid values"
    likelihood: "medium"
    impact: "high"
    mitigation: "Validate proposals against field schema from SoR; reject invalid"

  - id: "R-004"
    name: "Security - Credential Exposure"
    description: "SoR credentials exposed in browser or logs"
    likelihood: "low"
    impact: "high"
    mitigation: "All SoR communication through backend adapter; never expose creds to frontend"

  - id: "R-005"
    name: "MCP Protocol Changes"
    description: "MCP spec evolves, breaking existing adapters"
    likelihood: "medium"
    impact: "medium"
    mitigation: "Pin MCP versions; abstract MCP-specific code in adapters"

# =============================================================================
# OPEN QUESTIONS
# =============================================================================

openQuestions:
  - id: "Q-001"
    question: "Batch conflict handling (FM-004): All-or-nothing or per-field?"
    status: "decided"
    decision: "B - Per-field"
    rationale: "Show success/failure per field, let user retry failed ones"

  - id: "Q-002"
    question: "Card archival: Auto-archive closed activities, or manual?"
    status: "decided"
    decision: "A - Manual"
    rationale: "It's the user's persistent record - they decide what's important to remember"

  - id: "Q-003"
    question: "Multi-device sync: Real-time or on-demand refresh?"
    status: "answered"
    answer: "Real-time via Firebase"

# =============================================================================
# SCOPE DECISIONS (Post-Research)
# =============================================================================

scopeDecisions:
  - id: "SD-001"
    decision: "DISCO-002 covers Scenarios 1 & 2 only (pull-based)"
    rationale: |
      Scenarios 3 & 4 (SoR push to human) require separate design work.
      SoR push mechanisms are complex and platform-specific.
      Defer to DISCO-003 for push architecture.
    scenarios:
      inScope:
        - "Scenario 1: User → AI → SoR (user initiates)"
        - "Scenario 2: User clicks card → Resume conversation"
      outOfScope:
        - "Scenario 3: SoR → Human (new work arrives)"
        - "Scenario 4: SoR → Human (update to existing work)"

  - id: "SD-002"
    decision: "Design for hosted-first, with local fallback for development"
    rationale: |
      - Multi-user support required for real demos
      - Hosted architecture is more realistic for production
      - Local mode useful for development without network dependencies
    primaryTarget: "hosted"
    secondaryTarget: "local"

# =============================================================================
# HOSTED ARCHITECTURE RECOMMENDATION
# =============================================================================

hostedArchitecture:
  summary: |
    NEXUS runs in browser. Orchestrator + MCP + AI run in cloud.
    Browser connects via HTTP/SSE to hosted services.

  diagram: |
    ┌─────────────┐         ┌───────────────────────────────┐         ┌─────────┐
    │   NEXUS     │  HTTPS  │      Cloud Services           │  HTTPS  │   SoR   │
    │  (Browser)  │────────▶│  ┌─────────────────────────┐  │────────▶│ (cloud) │
    └─────────────┘         │  │ Orchestrator            │  │         └─────────┘
                            │  │  • Auth context         │  │
                            │  │  • Session management   │  │
                            │  │  • Event routing        │  │
                            │  └───────────┬─────────────┘  │
                            │              │                │
                            │  ┌───────────▼─────────────┐  │
                            │  │ AI Service              │  │
                            │  │  • Claude API / GPT     │  │
                            │  │  • Tool orchestration   │  │
                            │  └───────────┬─────────────┘  │
                            │              │                │
                            │  ┌───────────▼─────────────┐  │
                            │  │ MCP Server (SSE mode)   │  │
                            │  │  • ServiceNow adapter   │  │
                            │  │  • SoR-agnostic tools   │  │
                            │  └─────────────────────────┘  │
                            └───────────────────────────────┘

  components:
    browser:
      - name: "NEXUS UI"
        tech: "React/Vanilla JS"
        role: "Canvas + Workbench rendering"
      - name: "Firebase Client"
        tech: "Firebase SDK"
        role: "Card persistence, real-time sync"

    cloud:
      - name: "Orchestrator"
        tech: "Node.js / Cloudflare Workers / Firebase Functions"
        role: "Routes browser requests to AI, manages sessions"
      - name: "AI Service"
        tech: "Claude API / OpenAI / Vertex AI"
        role: "Intent understanding, tool selection"
      - name: "MCP Server"
        tech: "Python (echelon-ai-labs)"
        role: "SoR communication via SSE mode"

  hostingOptions:
    - option: "Firebase + Cloud Run"
      pros: "Integrated with existing Firebase, auto-scaling"
      cons: "Cold starts, learning curve"
    - option: "Cloudflare Workers"
      pros: "Edge deployment, fast, cheap"
      cons: "Different runtime (no Node.js native)"
    - option: "Simple Node.js on VM"
      pros: "Full control, familiar"
      cons: "Manual scaling, ops overhead"

  recommendation: |
    For demos: Firebase Functions + Cloud Run.
    - Firebase already in use for card persistence
    - Cloud Run can host the MCP server (Python)
    - Unified billing and deployment

# =============================================================================
# NEXT STEPS
# =============================================================================

nextSteps:
  - "Proceed to T-2: Define & Document"
  - "Document hosted architecture in detail"
  - "Create DISCO-003 placeholder for push architecture"
