# Stage T-4: Consensus
# DISCO-002: NEXUS Integration Layer

stage:
  id: "T-4"
  name: "Consensus"
  status: "complete"
  completedAt: "2026-01-23T11:31:36Z"
  method: "retroactive"

consensus:
  summary: |
    Collaborative discussion with user to establish architectural decisions.
    Key decisions locked through dialogue.

  decisions:
    - id: "D-001"
      topic: "SoR Coupling"
      decision: "Agnostic"
      rationale: "NEXUS should not know or care what SoR it's connected to"
      status: "locked"

    - id: "D-002"
      topic: "Integration Pattern"
      decision: "Adapter"
      rationale: "Each SoR has an adapter that translates to/from standard events"
      status: "locked"

    - id: "D-003"
      topic: "Activity Types"
      decision: "Freeform string"
      rationale: "Stay agnostic; adapter passes through whatever SoR calls it"
      status: "locked"

    - id: "D-004"
      topic: "Field Names"
      decision: "Pass-through with displayLabel"
      rationale: |
        - 'field': SoR native name (for write-back)
        - 'displayLabel': Human-readable (for UI rendering)
        - Adapter provides both
      status: "locked"

    - id: "D-005"
      topic: "Proposal Workflow"
      decision: "Batch"
      rationale: "User and AI negotiate in chat, then batch approve/reject all proposals"
      status: "locked"

    - id: "D-006"
      topic: "Card Storage"
      decision: "Firebase"
      rationale: "NEXUS persists activity cards locally (design assumption)"
      status: "locked"

    - id: "D-007"
      topic: "Conversation History"
      decision: "Stored with card in NEXUS DB"
      rationale: "Chat history lives in NEXUS, not SoR"
      status: "locked"

    - id: "D-008"
      topic: "Offline Behavior"
      decision: "Fail gracefully"
      rationale: "No offline mode; show error if SoR unreachable"
      status: "locked"

  eventContract:
    events:
      - type: "activity.new"
        direction: "SoR → NEXUS"
        purpose: "New work item arrives"
        requiredFields: ["activityId", "activityType", "title"]
        optionalFields: ["summary", "fields", "priority", "meta"]

      - type: "activity.update"
        direction: "SoR → NEXUS"
        purpose: "Existing item changed"
        requiredFields: ["activityId", "changes"]
        optionalFields: ["urgency"]

      - type: "activity.open"
        direction: "User → Orchestrator"
        purpose: "User clicks a card"
        requiredFields: ["activityId"]

      - type: "intent.submit"
        direction: "User → AI"
        purpose: "User sends a chat message"
        requiredFields: ["activityId", "message"]

      - type: "field.propose"
        direction: "AI → NEXUS"
        purpose: "AI suggests field changes (batch)"
        requiredFields: ["activityId", "proposals"]

      - type: "field.commit"
        direction: "User → SoR"
        purpose: "User approves proposed changes"
        requiredFields: ["activityId", "commits"]

      - type: "message.ai"
        direction: "AI → NEXUS"
        purpose: "AI sends chat message"
        requiredFields: ["activityId", "text"]

      - type: "message.human"
        direction: "NEXUS → AI"
        purpose: "User's message (for logging/echo)"
        requiredFields: ["activityId", "text"]

  dataContracts:
    ActivityField:
      field: "string (SoR native name)"
      displayLabel: "string (human readable)"
      value: "string (current value)"
      displayValue: "string? (formatted value)"

    FieldProposal:
      field: "string"
      displayLabel: "string"
      currentValue: "string?"
      proposedValue: "string"
      proposedDisplayValue: "string?"
      reason: "string? (AI's rationale)"

nextSteps:
  - "Finalize T-4 with any remaining consensus items"
  - "Proceed to T-3 Analysis & Risk"
  - "Identify edge cases and failure modes"
