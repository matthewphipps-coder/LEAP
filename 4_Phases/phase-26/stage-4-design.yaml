# =============================================================================
# STAGE 4: DESIGN - Phase 26
# =============================================================================

metadata:
  phase: 26
  phaseName: "FactoryAICompliance"
  stage: 4
  stageName: "design"
  created: "2026-01-21T19:34:00Z"
  status: "in-progress"
  gateApproval: "Stage 3 approved with !Proceed at 2026-01-21T19:34:03Z"
  previousStage: "stage-3-analysis.yaml"

designObjective: "Implementation plan for Template Enforcement approach"

# =============================================================================
# IMPLEMENTATION PLAN
# =============================================================================

implementationSteps:
  
  1:
    name: "Refactor archetype.yaml"
    file: "2_GoldSource/archetypes/agentic-dashboard/archetype.yaml"
    action: "Full rewrite as pattern quick reference"
    details: |
      - Update version to 2.0.0
      - Add patternDecisionTree section with 5 patterns
      - Add antiPatterns section with 3 prohibitions
      - Add deprecatedComponents section (nav-ui.js)
      - Remove stale scaffoldStructure details
      - Keep under 100 lines
  
  2:
    name: "Update FACTORY_README.yaml"
    file: "2_GoldSource/governance/FACTORY_README.yaml"
    action: "Add archetype to firstSteps reading list"
    details: |
      - Insert new step after step 4 (demo-rules.yaml)
      - New step: "Read archetypes/agentic-dashboard/archetype.yaml"
      - Renumber subsequent steps
  
  3:
    name: "Update FACTORY_TASK_TEMPLATE.md"
    file: "2_GoldSource/governance/FACTORY_TASK_TEMPLATE.md"
    action: "Update Stage 4 and Stage 5 reading lists"
    details: |
      Stage 4 additions:
      - Add archetype.yaml to reading list
      - Add meta/functionality.yaml to reading list
      
      Stage 5 fix:
      - Change lines 130-170 to lines 130-170 AND 175-341
  
  4:
    name: "Update stage-4-design.yaml template"
    file: "2_GoldSource/governance/templates/stage-4-design.yaml"
    action: "Add scaffoldPatternDecisions section"
    details: |
      Add new section after visualDesign:
      - pageTabs: question, decision, ifYes
      - sidebarActions: question, decision, ifYes
      - featureState: question, decision, ifYes
      - settingsSections: question, decision, ifYes
      - modalDialog: question, decision, ifYes
      
      Add antiPatternConfirmations:
      - No custom navigation bars
      - Content on correct page
      - No placeholder text
  
  5:
    name: "Update stage-5-implementation.yaml template"
    file: "2_GoldSource/governance/templates/stage-5-implementation.yaml"
    action: "Add patternVerification section"
    details: |
      Add new section after filesModified:
      - Verify patterns used match Stage 4 decisions
      - Confirm no anti-patterns created
      - References back to Stage 4 artifact

# =============================================================================
# FILE-BY-FILE CHANGES
# =============================================================================

filesToModify:

  - file: "2_GoldSource/archetypes/agentic-dashboard/archetype.yaml"
    currentLines: 81
    targetLines: "~95 (under 100)"
    sections:
      remove:
        - "scaffoldStructure.shell (stale nav/footer references)"
        - "provides (move to conceptual description)"
      add:
        - "patternDecisionTree (5 patterns with when/use/doNot)"
        - "antiPatterns (3 prohibitions)"
        - "deprecatedComponents (nav-ui.js)"
        - "activeComponents (sidebar-ui.js, settings-ui.js)"

  - file: "2_GoldSource/governance/FACTORY_README.yaml"
    currentLines: 147
    change: "Insert step 5 in firstSteps section"
    insertAfter: "step 4 (demo-rules.yaml)"
    insertContent: |
      5: "Read archetypes/agentic-dashboard/archetype.yaml (pattern decisions)"

  - file: "2_GoldSource/governance/FACTORY_TASK_TEMPLATE.md"
    currentLines: 181
    changes:
      - location: "Stage 4 reading list (around line 84-87)"
        add: |
          - `archetypes/agentic-dashboard/archetype.yaml` (pattern decisions)
          - `meta/functionality.yaml` (what scaffold provides)
      
      - location: "Stage 5 reading list (around line 106)"
        change: |
          Current: `meta/architectural-standards.yaml` (lines 130-170)
          New: `meta/architectural-standards.yaml` (lines 130-170: naming, locked files)
          New: `meta/architectural-standards.yaml` (lines 175-341: PAGE_TABS, sidebar, multi-page)

  - file: "2_GoldSource/governance/templates/stage-4-design.yaml"
    currentLines: 165
    insertAfter: "visualDesign section (around line 65)"
    insertContent: |
      # =============================================================================
      # SCAFFOLD PATTERN DECISIONS (Required)
      # =============================================================================
      scaffoldPatternDecisions:
        description: "Factory must explicitly decide on each pattern before proceeding"
        
        patterns:
          pageTabs:
            question: "Will this feature need a dedicated page?"
            decision: "[yes/no]"
            ifYes: "Add entry to PAGE_TABS in constants.js"
          
          sidebarActions:
            question: "Will this page need contextual actions?"
            decision: "[yes/no]"
            ifYes: "Add to PAGE_SIDEBAR_ACTIONS[pageId] in constants.js"
          
          featureState:
            question: "Will this feature need its own state?"
            decision: "[yes/no]"
            ifYes: "Use registerStateSlice() from state.js"
          
          settingsSections:
            question: "Will this feature need settings?"
            decision: "[yes/no]"
            ifYes: "Add to SETTINGS_MENU and SETTINGS_SECTIONS in constants.js"
          
          modalDialog:
            question: "Will this feature need a detail dialog?"
            decision: "[yes/no]"
            ifYes: "Use lazy modal creation pattern (create DOM on first open)"
        
        antiPatternConfirmations:
          - confirmation: "I will NOT create custom navigation bars"
            verified: "[true/false]"
          - confirmation: "Feature content will render on its correct page"
            verified: "[true/false]"
          - confirmation: "I will NOT leave placeholder text"
            verified: "[true/false]"

  - file: "2_GoldSource/governance/templates/stage-5-implementation.yaml"
    currentLines: 68
    insertAfter: "filesModified section (around line 40)"
    insertContent: |
      # =============================================================================
      # PATTERN VERIFICATION (Required before !Proceed)
      # =============================================================================
      patternVerification:
        description: "Verify patterns used match Stage 4 decisions"
        referenceArtifact: "stage-4-design.yaml scaffoldPatternDecisions"
        
        patternsUsed:
          pageTabs:
            stage4Decision: "[copy from stage-4]"
            implemented: "[yes/no/n/a]"
            files: "[list files where PAGE_TABS was modified]"
          
          sidebarActions:
            stage4Decision: "[copy from stage-4]"
            implemented: "[yes/no/n/a]"
            files: "[list files where PAGE_SIDEBAR_ACTIONS was modified]"
          
          featureState:
            stage4Decision: "[copy from stage-4]"
            implemented: "[yes/no/n/a]"
            files: "[list files where registerStateSlice was used]"
        
        antiPatternCheck:
          noCustomNavBars: "[confirmed]"
          contentOnCorrectPage: "[confirmed]"
          noPlaceholderText: "[confirmed]"

# =============================================================================
# VERIFICATION PLAN
# =============================================================================

verificationPlan:
  
  automated:
    - test: "YAML syntax validation"
      command: "python3 -c \"import yaml; yaml.safe_load(open('FILE'))\" for each modified file"
  
  manual:
    - test: "Review archetype.yaml for completeness"
      steps:
        - "Verify version is 2.0.0"
        - "Verify patternDecisionTree has 5 patterns"
        - "Verify antiPatterns has 3 items"
        - "Verify file is under 100 lines"
    
    - test: "Trace Factory AI reading path"
      steps:
        - "Start at FACTORY_README.yaml firstSteps"
        - "Verify archetype.yaml is in reading sequence"
        - "Check FACTORY_TASK_TEMPLATE Stage 4 includes archetype + functionality"
        - "Check Stage 5 includes correct line ranges"
    
    - test: "Verify templates have new sections"
      steps:
        - "Open stage-4-design.yaml template"
        - "Verify scaffoldPatternDecisions section exists"
        - "Open stage-5-implementation.yaml template"
        - "Verify patternVerification section exists"
  
  realWorld:
    - test: "Next Factory run (v2.2.0 or later)"
      steps:
        - "Run Factory to create a demo"
        - "Check Stage 4 artifact has scaffoldPatternDecisions filled out"
        - "Check Stage 5 artifact has patternVerification filled out"
        - "Verify no custom navigation bars created"
        - "Verify feature content on correct pages"

# =============================================================================
# NEXT STAGE
# =============================================================================

nextStage:
  name: "implementation"
  focus: "Execute the 5 file modifications"
  requires: "!Proceed"
