metadata:
  type: "reference"
  name: "LEAP System Architecture"
  purpose: "Complete system architecture reference for AI agents"
  version: "1.0.0"
  created: "2026-01-15"
  lastUpdated: "2026-01-15"
  status: "active"

lifecycle:
  currentStage: "implementation"
  status: "in-progress"
  nextStage: "validation"

humanInterface:
  checkpointRequired: false
  context: "CRITICAL - Read before any code changes"

readMeFirst:
  warning: "⚠️ DO NOT MODIFY CODE WITHOUT READING THIS FILE"
  purpose: "This document maps the entire LEAP architecture"
  whenToRead:
    - "Before making any code changes"
    - "When adding new features"
    - "When debugging architectural issues"
    - "When onboarding to the project"
  benefit: "Reduces onboarding time from 2 hours to 10 minutes"

systemOverview:
  name: "LEAP"
  tagline: "AI-First Workflow Assistant"
  description: "A complete UX reimagining that replaces forms and lists with an AI-powered, people-centric interface"
  version: "v6.8.0-partnership"
  architecture: "Modular ES6 with Firebase Backend"
  codebaseSize: "~8,400 lines of JavaScript"
  
  quickStart:
    - "Entry: index.html → app.js"
    - "State: Singleton StateManager (src/core/state-manager.js)"
    - "Data: Firebase Firestore with real-time listeners"
    - "Pattern: Service (logic) + UI (render) + Style (CSS)"
  
  keyPrinciple: "Reactive architecture - all changes flow through Firebase, even local ones"

entryPoints:
  main:
    file: "index.html"
    loads: "app.js"
    purpose: "Main application"
    url: "http://localhost:8001 (dev) or /BIZ/ (production)"
    
  auth:
    file: "login.html"
    loads: "login.js"
    purpose: "Authentication flow"
    redirect: "Redirects to index.html after successful login"
    
  orchestrator:
    file: "app.js"
    lines: 1003
    role: "Main controller - bootstraps app, wires events, manages Firebase listeners"
    rule: "No business logic - delegates to services"
    responsibilities:
      - "Import all modules"
      - "Initialize Firebase listeners (setupListeners)"
      - "Wire UI components"
      - "Manage authentication state"
      - "Coordinate data flow between services and UI"

modules:
  core:
    location: "src/core/"
    purpose: "Application foundation - must load before everything else"
    totalLines: 1393
    fileCount: 7
    
    files:
      firebase:
        file: "firebase.js"
        lines: 53
        exports: "app, db, auth"
        purpose: "Firebase initialization and configuration"
        critical: "⚠️ MUST LOAD FIRST - Everything depends on this"
        provides:
          - "db: Firestore database instance"
          - "auth: Firebase Auth instance"
          - "app: Firebase app instance"
        features:
          - "Offline persistence (IndexedDB)"
          - "Error handling for persistence failures"
        dependencies: "firebase/app, firebase/auth, firebase/firestore"
        
      stateManager:
        file: "state-manager.js"
        lines: 105
        exports: "state (singleton)"
        purpose: "Centralized application state management"
        pattern: "Singleton class with private state and controlled access"
        critical: "⚠️ Single source of truth for all application state"
        
        state:
          tasks: "Array of task objects"
          categories: "Array of user-created categories"
          user: "Current user object (from Firebase Auth)"
          filter: "Current filter { type, value }"
          searchQuery: "Current search string"
          activeExperienceId: "Active scenario/experience ID (for Chameleon mode)"
          unsubscribers: "Array of Firebase listener cleanup functions"
        
        methods:
          getters: "Read-only access to state (e.g., state.tasks)"
          setters: "Controlled mutations (e.g., state.setTasks([...]))"
          utilities: "getTaskById, addUnsubscriber, clearUnsubscribers, reset"
        
        exposedTo: "window.state (for debugging and test automation)"
        
      constants:
        file: "constants.js"
        lines: 21
        exports: "DEBUG, log, logError, APP_VERSION, FLAGS"
        purpose: "App-wide constants and feature flags"
        
        constants:
          DEBUG: "false (production mode)"
          APP_VERSION: "v6.8.0-partnership"
          USE_NEW_CARD_SYSTEM: "false"
          FLAGS:
            CHAMELEON_UI: "true (Phase 7 features enabled)"
        
        functions:
          log: "Conditional logging (only if DEBUG=true)"
          logError: "Always logs errors"
        
      authService:
        file: "auth-service.js"
        lines: ~150
        exports: "fetchUserData, logout, setupAuthListener, createUserAvatarHTML, initializeUser, updateUserXP"
        purpose: "Authentication logic, user profile management, XP updates"
        responsibilities:
          - "Fetch user data from Firestore"
          - "Handle logout flow"
          - "Create user avatar HTML"
          - "Initialize new users"
          - "Update user XP (gamification)"
        
      themeManager:
        file: "theme-manager.js"
        lines: ~250
        exports: "themeManager, initTheme"
        purpose: "Chameleon branding system (Phase 7)"
        features:
          - "Dynamic theme switching"
          - "Customer logo integration"
          - "CSS variable manipulation"
          - "Theme persistence"
        
      css:
        base:
          file: "base.css"
          lines: ~250
          purpose: "CSS variables (colors, spacing, fonts) and reset"
          critical: "⚠️ MUST LOAD FIRST in CSS cascade"
          provides:
            - "CSS custom properties (--color-*, --spacing-*, --font-*)"
            - "Global reset styles"
            - "Base typography"
        
        layout:
          file: "layout.css"
          lines: ~400
          purpose: "Layout system (grid, flexbox, positioning)"
          provides:
            - "App container layout"
            - "Responsive grid system"
            - "Flexbox utilities"
  
  features:
    location: "src/features/"
    purpose: "Business logic modules - each feature is self-contained"
    totalLines: 4292
    fileCount: 12
    pattern: "Each feature has [feature]-service.js (logic) + [feature]-ui.js (render) + [feature].css (style)"
    
    modules:
      tasks:
        location: "src/features/tasks/"
        purpose: "Core task management functionality"
        
        files:
          service:
            file: "task-service.js"
            lines: 236
            exports: "addTask, toggleTask, deleteTask, updateTaskProperties, saveChatHistory, batchUpdateTasks, reorderTasksMethod"
            purpose: "Task CRUD operations"
            pattern: "Pure functions with dependency injection"
            
            functions:
              addTask: "Create new task in Firestore"
              toggleTask: "Toggle completion status (with XP reward)"
              deleteTask: "Soft delete (sets deleted: true)"
              updateTaskProperties: "Update arbitrary task properties"
              saveChatHistory: "Save AI chat history to task"
              batchUpdateTasks: "Batch update multiple tasks"
              reorderTasksMethod: "Reorder tasks using 'order' field"
            
            dependencies: "db, addDoc, updateDoc, doc, collection (from Firebase)"
            
          ui:
            file: "task-ui.js"
            lines: ~400
            exports: "renderTasks, calcQuantumScore"
            purpose: "Task rendering logic"
            responsibilities:
              - "Render task list to DOM"
              - "Create task card HTML"
              - "Handle card-specific rendering (ping, signal, decision, activity)"
              - "Calculate quantum score (urgency visualization)"
            
          filters:
            file: "task-filters.js"
            lines: ~200
            exports: "isToday, isTomorrow, isThisWeek, isDueWithinHour, getCurrentTimePeriod, calculateTaskStats, getUrgencyClass"
            purpose: "Temporal logic and filtering algorithms"
            responsibilities:
              - "Date/time calculations"
              - "Task filtering logic"
              - "Statistics calculation"
              - "Urgency classification"
      
      cards:
        location: "src/features/cards/"
        purpose: "Card type system (Ping, Signal, Decision, Activity, Task)"
        
        files:
          factory:
            file: "card-factory.js"
            exports: "createTask, createPing, createSignal, createDecision, createActivity"
            purpose: "Card type generators"
            pattern: "Factory pattern for creating different card types"
            
          validators:
            file: "card-validators.js"
            exports: "validateCard"
            purpose: "Schema validation for card data"
            
          types:
            file: "card-types.js"
            purpose: "Card type definitions and constants"
      
      ai:
        location: "src/features/ai/"
        purpose: "AI provider integration (Gemini, Claude)"
        
        files:
          service:
            file: "ai-service.js"
            lines: ~300
            exports: "askAI, askGemini, askClaude, showLoading, hideLoading, addChatMessage"
            purpose: "Unified interface for AI providers"
            
            providers:
              gemini:
                model: "gemini-1.5-flash"
                endpoint: "Google AI Studio API"
              claude:
                model: "claude-3-5-sonnet-20241022"
                endpoint: "Anthropic API"
            
            features:
              - "Provider abstraction (askAI delegates to askGemini or askClaude)"
              - "API key management (from localStorage)"
              - "Loading state management"
              - "Chat message formatting"
              - "Error handling"
            
          chatManager:
            file: "chat-manager.js"
            purpose: "Chat history management and persistence"
      
      nexus:
        location: "src/features/nexus/"
        purpose: "Nexus orb system (AI command center)"
        
        files:
          nexus:
            file: "nexus.js"
            lines: 626
            exports: "NexusOrb class"
            purpose: "Nexus orb system - always-visible AI interface"
            
            features:
              - "Plasma bar hover expansion"
              - "Smart greeting based on time and context"
              - "Quick action chips"
              - "Command processing (/scenario, /simulate, /seed, /clear)"
              - "AI thinking state"
              - "Proactive notifications"
            
            initialization: "Auto-initializes on DOMContentLoaded"
            exposed: "window.nexusOrb, window.NexusOrb"
            
          scenarioService:
            file: "scenario-service.js"
            purpose: "Scenario/experience management (Chameleon mode)"
            
          experienceContext:
            file: "experience-context.js"
            purpose: "Context for AI personalization (hero, company, intent)"
      
      simulation:
        location: "src/features/simulation/"
        purpose: "Demo data generation"
        
        files:
          enterpriseSim:
            file: "enterprise-sim.js"
            purpose: "Generate enterprise demo cards (/simulate command)"
  
  ui:
    location: "src/ui/"
    purpose: "UI components and utilities"
    totalLines: 2714
    fileCount: 13
    pattern: "Component.js + component.css (co-located styling)"
    
    components:
      location: "src/ui/components/"
      count: 9
      pattern: "Each component is self-contained with its own CSS"
      
      files:
        identityHub:
          file: "identity-hub.js"
          lines: 142
          exports: "identityHub (singleton)"
          purpose: "Logo loop and horizon bar (top-left identity, top-right temporal/user nodes)"
          features:
            - "Customer logo integration (Clearbit API)"
            - "Temporal node (date display, updates every 60s)"
            - "User node (initials from email)"
            - "Logout handler"
          
        settingsStudio:
          file: "settings-studio.js"
          purpose: "Settings panel (Connectivity, Identity, System, Theme tabs)"
          
        taskDetailUI:
          file: "task-detail-ui.js"
          lines: ~500
          exports: "setupTaskDetail"
          purpose: "Task inspector modal with AI chat"
          features:
            - "Two-pane layout (Edit/Meta tabs | AI Chat)"
            - "Auto-first-message (AI generates contextual greeting)"
            - "Chat history persistence"
            - "Integrated input bar (attach, voice, provider selector)"
            - "Meta chips (urgency, agent, XP, tags)"
          
        filtersUI:
          file: "filters-ui.js"
          exports: "renderFilters, updateFilterButtons, initStatusDropZones"
          purpose: "Filter rendering and drag-drop zones"
          
        searchUI:
          file: "search-ui.js"
          exports: "setupOmniBar"
          purpose: "Omni-bar (bottom center input for task creation)"
          
        modalUI:
          file: "modal-ui.js"
          exports: "setupCategoryModal"
          purpose: "Category creation modal"
          
        settingsUI:
          file: "settings-ui.js"
          exports: "setupTheme, setupSettingsModal"
          purpose: "API keys modal and theme switcher"
          
        scenarioBuilderUI:
          file: "scenario-builder-ui.js"
          exports: "ScenarioBuilderUI class"
          purpose: "Scenario architect UI (Chameleon mode)"
          
        briefingUI:
          file: "briefing-ui.js"
          exports: "briefingUI"
          purpose: "Briefing display for scenarios"
    
    utils:
      location: "src/ui/utils/"
      purpose: "Reusable UI utilities"
      
      files:
        dragDrop:
          file: "drag-drop.js"
          exports: "setupDragAndDrop"
          purpose: "Drag and drop logic for task reordering and status changes"
          
        gamification:
          file: "gamification.js"
          exports: "rewardUser"
          purpose: "XP rewards and confetti animations"
          
        stars:
          file: "stars.js"
          purpose: "Starfield background animation"

dataFlow:
  primary:
    name: "User Action → Firebase → UI (Reactive Pattern)"
    description: "All changes flow through Firebase, ensuring real-time sync across all clients"
    
    steps:
      - step: 1
        action: "User clicks checkbox"
        handler: "UI component (task-ui.js)"
        
      - step: 2
        action: "toggleTask() called"
        location: "task-service.js"
        parameters: "task, db, updateDoc, doc, rewardUser"
        
      - step: 3
        action: "Firebase updateDoc() executed"
        result: "Data written to Firestore"
        collection: "tasks"
        
      - step: 4
        action: "onSnapshot listener fires"
        location: "app.js setupListeners()"
        trigger: "Firestore detects change"
        
      - step: 5
        action: "state.setTasks() called"
        location: "state-manager.js"
        result: "State updated with new task data"
        
      - step: 6
        action: "renderTasks() called"
        location: "app.js"
        trigger: "State change"
        
      - step: 7
        action: "DOM updated"
        location: "task-ui.js renderTasks()"
        result: "User sees updated UI"
    
    keyInsight: "Even local changes go through Firebase. This ensures consistency and enables real-time collaboration."
    rule: "Don't fight the reactive pattern - embrace it. All state changes should flow through Firebase."
  
  secondary:
    name: "AI Integration Flow"
    description: "How AI chat messages are processed and persisted"
    
    steps:
      - step: 1
        action: "User sends chat message"
        location: "task-detail-ui.js"
        
      - step: 2
        action: "askAI() called"
        location: "ai-service.js"
        parameters: "prompt, provider (gemini or claude)"
        
      - step: 3
        action: "API request to Gemini/Claude"
        authentication: "API key from localStorage"
        
      - step: 4
        action: "Response received and formatted"
        formatting: "HTML with green highlights, paragraphs, lists"
        
      - step: 5
        action: "Message displayed in chat"
        location: "task-detail-ui.js"
        
      - step: 6
        action: "Chat history saved to Firebase"
        location: "saveChatHistory() in task-service.js"
        persistence: "Stored in task document, persists across sessions"
  
  initialization:
    name: "App Initialization Flow"
    description: "What happens when the app loads"
    
    steps:
      - step: 1
        action: "index.html loads"
        loads: "CSS files, app.js (type=module)"
        
      - step: 2
        action: "app.js executes"
        imports: "All modules (firebase, state, services, UI components)"
        
      - step: 3
        action: "Firebase initialized"
        location: "firebase.js"
        result: "db, auth available"
        
      - step: 4
        action: "onAuthStateChanged listener fires"
        location: "app.js"
        check: "Is user logged in?"
        
      - step: 5
        action: "If logged in: setupListeners()"
        location: "app.js"
        creates: "Firebase listeners for tasks, categories"
        
      - step: 6
        action: "UI components initialize"
        components: "identityHub, settingsStudio, nexusOrb, etc."
        
      - step: 7
        action: "Initial render"
        triggers: "renderTasks(), renderFilters()"
        result: "User sees dashboard"

dependencies:
  criticalPath:
    description: "These must load in order - failure breaks the app"
    
    loadOrder:
      - order: 1
        file: "firebase.js"
        provides: "db, auth"
        usedBy: "All services"
        critical: "⚠️ If this fails, entire app breaks"
        errorHandling: "Try-catch with logError, but no graceful degradation"
        
      - order: 2
        file: "state-manager.js"
        provides: "state singleton"
        usedBy: "All components"
        critical: "⚠️ Single source of truth"
        pattern: "Singleton - only one instance exists"
        
      - order: 3
        file: "constants.js"
        provides: "DEBUG, log, APP_VERSION, FLAGS"
        usedBy: "All modules"
        critical: "Feature flags and logging infrastructure"
  
  appJsImports:
    description: "What app.js imports and why"
    
    core:
      - import: "firebase.js"
        provides: "app, db, auth"
        usage: "Passed to all services for Firebase operations"
        
      - import: "state-manager.js"
        provides: "state"
        usage: "Read/write application state"
        
      - import: "auth-service.js"
        provides: "fetchUserData, logout, createUserAvatarHTML, etc."
        usage: "Authentication logic"
        
      - import: "theme-manager.js"
        provides: "themeManager, initTheme"
        usage: "Chameleon branding"
        
      - import: "constants.js"
        provides: "DEBUG, log, APP_VERSION, FLAGS"
        usage: "Logging and feature flags"
    
    features:
      - import: "task-service.js"
        provides: "addTask, toggleTask, deleteTask, etc."
        usage: "Task CRUD operations"
        
      - import: "task-ui.js"
        provides: "renderTasks, calcQuantumScore"
        usage: "Task rendering"
        
      - import: "task-filters.js"
        provides: "isToday, calculateTaskStats, etc."
        usage: "Temporal logic"
        
      - import: "card-factory.js"
        provides: "createTask, createPing, createSignal, etc."
        usage: "Card creation"
        
      - import: "ai-service.js"
        provides: "askAI, askGemini, askClaude"
        usage: "AI integration"
    
    ui:
      - import: "All 9 UI components"
        usage: "UI rendering and interaction"
        
      - import: "drag-drop.js, gamification.js, stars.js"
        usage: "UI utilities"
  
  dependencyInjection:
    pattern: "Explicit Dependency Injection"
    description: "Services receive dependencies as function parameters"
    
    example:
      function: "addTask(text, currentUser, currentFilter, db, addDoc, collection)"
      parameters:
        - "text: Task text (data)"
        - "currentUser: User object (state)"
        - "currentFilter: Filter object (state)"
        - "db: Firestore instance (infrastructure)"
        - "addDoc: Firestore function (infrastructure)"
        - "collection: Firestore function (infrastructure)"
    
    rationale:
      - "Makes services pure functions (no hidden dependencies)"
      - "Easier to test (can mock dependencies)"
      - "Explicit about what each service needs"
    
    tradeoff:
      - "Verbose function signatures (5-7 parameters)"
      - "Repetitive parameter passing"
    
    alternative: "Could use dependency injection container, but current approach is explicit and clear"

cssArchitecture:
  mainFile: "index.css"
  pattern: "@import cascade"
  totalLines: 15
  description: "Modular CSS with explicit load order"
  
  loadOrder:
    - order: 1
      file: "src/core/base.css"
      lines: ~250
      purpose: "CSS variables (colors, spacing, fonts) and reset"
      critical: "⚠️ MUST LOAD FIRST - Provides variables to all components"
      provides:
        - "--color-* (color palette)"
        - "--spacing-* (spacing scale)"
        - "--font-* (typography)"
        - "Global reset styles"
      
    - order: 2
      file: "src/core/layout.css"
      lines: ~400
      purpose: "Layout system (grid, flexbox, positioning)"
      provides:
        - "App container layout"
        - "Responsive grid"
        - "Flexbox utilities"
      
    - order: 3
      files:
        - "src/ui/components/tasks.css"
        - "src/ui/components/modal.css"
        - "src/ui/components/filters.css"
        - "src/ui/components/settings.css"
        - "src/ui/components/search.css"
        - "src/ui/components/plasma.css"
        - "src/ui/components/task-detail.css"
        - "src/ui/components/scenario-builder.css"
        - "src/ui/components/briefing.css"
      purpose: "Component-specific styles"
      pattern: "Each component has co-located CSS file"
  
  knownIssues:
    - id: "BUG-001"
      severity: "CRITICAL"
      issue: "Duplicate CSS loading"
      description: "index.html links CSS files directly (lines 17-19) AND index.css imports the same files"
      impact: "CSS changes don't apply reliably, specificity conflicts"
      location:
        - "index.html lines 17-19 (direct <link> tags)"
        - "index.css (@import statements)"
      solution: "Remove direct <link> tags from index.html, use only @import in index.css"
      plannedFix: "Phase 21.3"
      blocks: "BUG-002 (Card visibility)"
  
  bestPractices:
    - "Always import CSS in index.css, never add <link> tags to index.html"
    - "CSS variables in base.css, component styles in component.css"
    - "Follow BEM-lite naming (.nexus-orb, .nexus-orb--active)"
    - "Co-locate component CSS with component JS"

architecturalPatterns:
  triad:
    name: "Service-UI-Style Triad"
    description: "Every feature is split into three distinct layers"
    mandatedBy: "architectural-standards.yaml"
    
    structure:
      service:
        file: "[feature]-service.js"
        responsibility: "Business logic, Firebase CRUD operations"
        rule: "NO DOM ACCESS - Services are pure functions"
        example: "task-service.js (addTask, toggleTask, deleteTask)"
        
      ui:
        file: "[feature]-ui.js"
        responsibility: "DOM rendering, event handling"
        rule: "NO BUSINESS LOGIC - UI delegates to services"
        example: "task-ui.js (renderTasks, createTaskCard)"
        
      style:
        file: "[feature].css"
        responsibility: "Visual presentation only"
        rule: "Component-specific styles, no global overrides"
        example: "tasks.css"
    
    benefits:
      - "Clear separation of concerns"
      - "Services are testable (no DOM dependencies)"
      - "UI is swappable (could replace with React, Vue, etc.)"
      - "Styles are isolated (no global conflicts)"
    
    enforcement: "Code will be rejected if it violates Triad pattern"
    
  singletonState:
    name: "Centralized State Management"
    file: "src/core/state-manager.js"
    pattern: "Singleton class with private state and controlled access"
    
    implementation:
      class: "StateManager"
      instance: "state (exported singleton)"
      privateState: "_tasks, _categories, _user, _filter, _searchQuery, _activeExperienceId"
      publicAccess: "Getters (read-only) and Setters (controlled mutations)"
    
    benefits:
      - "Single source of truth"
      - "Prevents prop drilling"
      - "Centralized state updates"
      - "Easy to debug (window.state)"
    
    usage:
      read: "const tasks = state.tasks;"
      write: "state.setTasks([...newTasks]);"
    
    rule: "Never mutate state directly - always use setters"
    
  reactiveData:
    name: "Firebase Reactive Pattern"
    description: "All data changes flow through Firebase, triggering automatic UI updates"
    
    flow: "User Action → Service → Firebase → onSnapshot → State → UI"
    
    implementation:
      listener: "onSnapshot(query, (snapshot) => { ... })"
      location: "app.js setupListeners()"
      trigger: "Firestore detects any change (local or remote)"
      action: "state.setTasks() → renderTasks()"
    
    benefits:
      - "Real-time sync across all clients"
      - "Automatic UI updates"
      - "Offline support (IndexedDB persistence)"
      - "Consistent state (single source of truth)"
    
    rule: "Don't fight the reactive pattern - embrace it"
    antipattern: "Manually updating DOM without going through Firebase"
    
  dependencyInjection:
    name: "Explicit Dependency Injection"
    description: "Services receive all dependencies as function parameters"
    
    pattern: "Pure functions with explicit dependencies"
    
    example:
      before: "function addTask(text) { /* uses global db */ }"
      after: "function addTask(text, user, filter, db, addDoc, collection) { /* explicit */ }"
    
    benefits:
      - "No hidden dependencies"
      - "Easy to test (mock dependencies)"
      - "Clear about what each function needs"
      - "No global state pollution"
    
    tradeoff:
      - "Verbose function signatures"
      - "Repetitive parameter passing"
    
    alternative: "Could use DI container, but explicit is clearer for AI agents"

extensionPoints:
  newFeature:
    description: "How to add a new feature (e.g., Milestones)"
    example: "Adding a 'Milestones' feature to track project milestones"
    
    steps:
      - step: 1
        action: "Create feature module"
        location: "src/features/milestones/"
        files:
          - file: "milestone-service.js"
            content: "CRUD operations (addMilestone, updateMilestone, deleteMilestone)"
            pattern: "Pure functions with dependency injection"
            
          - file: "milestone-ui.js"
            content: "Rendering logic (renderMilestones, createMilestoneCard)"
            pattern: "DOM manipulation, no business logic"
            
          - file: "milestones.css"
            content: "Milestone-specific styles"
            pattern: "BEM-lite naming (.milestone-card, .milestone-card--complete)"
      
      - step: 2
        action: "Update state-manager.js"
        file: "src/core/state-manager.js"
        changes:
          - "Add private state: this._milestones = [];"
          - "Add getter: get milestones() { return this._milestones; }"
          - "Add setter: setMilestones(milestones) { this._milestones = milestones; }"
        
        code: |
          // In constructor
          this._milestones = [];
          
          // Add getter
          get milestones() { return this._milestones; }
          
          // Add setter
          setMilestones(milestones) {
            this._milestones = milestones || [];
          }
      
      - step: 3
        action: "Import in app.js"
        file: "app.js"
        changes:
          - "Import service and UI modules"
          - "Create wrapper functions if needed"
        
        code: |
          import { addMilestone, updateMilestone } from './src/features/milestones/milestone-service.js';
          import { renderMilestones } from './src/features/milestones/milestone-ui.js';
      
      - step: 4
        action: "Add Firebase listener in setupListeners()"
        file: "app.js"
        location: "setupListeners() function"
        
        code: |
          // In setupListeners(user, role)
          const qMilestones = query(
            collection(db, "milestones"),
            where("userId", "==", userId)
          );
          
          const unsubMilestones = onSnapshot(qMilestones, (snapshot) => {
            const newMilestones = [];
            snapshot.forEach((doc) => {
              newMilestones.push({ id: doc.id, ...doc.data() });
            });
            state.setMilestones(newMilestones);
            renderMilestones();
          });
          
          state.addUnsubscriber(unsubMilestones);
      
      - step: 5
        action: "Update index.css"
        file: "index.css"
        changes: "Add @import for milestone CSS"
        
        code: |
          @import './src/features/milestones/milestones.css';
      
      - step: 6
        action: "Update ARCHITECTURE.yaml"
        file: "ARCHITECTURE.yaml"
        changes: "Document the new feature in modules.features section"
    
    checklist:
      - "□ Created feature module (service + ui + css)"
      - "□ Updated state-manager.js"
      - "□ Imported in app.js"
      - "□ Added Firebase listener"
      - "□ Updated index.css"
      - "□ Updated ARCHITECTURE.yaml"
      - "□ Tested locally"
      - "□ Updated functionality.yaml"
  
  newCardType:
    description: "How to add a new card type (e.g., 'Note' card)"
    location: "src/features/cards/"
    
    steps:
      - step: 1
        action: "Add card factory function"
        file: "src/features/cards/card-factory.js"
        
        code: |
          export function createNote(text, metadata = {}) {
            return {
              type: 'note',
              text,
              completed: false,
              deleted: false,
              priority: 'low',
              status: 'inbox',
              category: null,
              userId: metadata.userId,
              createdAt: new Date().toISOString(),
              order: Date.now(),
              // Note-specific properties
              color: metadata.color || 'yellow',
              pinned: metadata.pinned || false
            };
          }
      
      - step: 2
        action: "Add validation schema"
        file: "src/features/cards/card-validators.js"
        
        code: |
          const noteSchema = {
            type: 'note',
            requiredFields: ['text', 'color'],
            optionalFields: ['pinned']
          };
      
      - step: 3
        action: "Update rendering logic"
        file: "src/features/tasks/task-ui.js"
        changes: "Add case for 'note' type in renderTasks()"
        
        code: |
          if (task.type === 'note') {
            // Render note card
            card.classList.add('note-card', `note-card--${task.color}`);
            // ... note-specific rendering
          }
      
      - step: 4
        action: "Add CSS styles"
        file: "src/ui/components/tasks.css"
        
        code: |
          .note-card {
            /* Note card styles */
          }
          
          .note-card--yellow {
            background: var(--color-note-yellow);
          }
  
  newUIComponent:
    description: "How to add a new UI component (e.g., 'Notifications Panel')"
    location: "src/ui/components/"
    
    steps:
      - step: 1
        action: "Create component file"
        file: "src/ui/components/notifications-ui.js"
        
        code: |
          export function setupNotifications(elements, state, dependencies) {
            // Component initialization
            // Event listeners
            // Rendering logic
            
            return {
              show: () => { /* ... */ },
              hide: () => { /* ... */ },
              addNotification: (notification) => { /* ... */ }
            };
          }
      
      - step: 2
        action: "Create component CSS"
        file: "src/ui/components/notifications.css"
        
        code: |
          .notifications-panel {
            /* Panel styles */
          }
          
          .notification-item {
            /* Item styles */
          }
      
      - step: 3
        action: "Import in app.js"
        file: "app.js"
        
        code: |
          import { setupNotifications } from './src/ui/components/notifications-ui.js';
          
          const notificationsUI = setupNotifications(
            { panel: document.getElementById('notifications-panel') },
            { getUser: () => state.user },
            { db, addDoc, collection }
          );
      
      - step: 4
        action: "Add CSS import"
        file: "index.css"
        
        code: |
          @import './src/ui/components/notifications.css';
  
  newCommand:
    description: "How to add a new Nexus command (e.g., /archive)"
    location: "src/features/nexus/nexus.js"
    
    steps:
      - step: 1
        action: "Add command handler in submitQuery()"
        file: "src/features/nexus/nexus.js"
        location: "NexusOrb.submitQuery() method"
        
        code: |
          if (query === '/archive') {
            this.collapse();
            await archiveCompletedTasks();
            return;
          }
      
      - step: 2
        action: "Implement command function"
        location: "app.js or appropriate service"
        
        code: |
          window.archiveCompletedTasks = async () => {
            const completedTasks = state.tasks.filter(t => t.completed);
            await batchUpdateTasks(
              completedTasks.map(t => t.id),
              { archived: true },
              db, writeBatch, doc
            );
          };

technologyStack:
  buildTool:
    name: "Vite"
    version: "7.3.1"
    config: "vite.config.js"
    
    devServer:
      port: 8001
      open: true
      command: "npm run dev"
    
    build:
      outDir: "dist"
      target: "esnext"
      command: "npm run build"
      
    preview:
      command: "npm run preview"
    
    multiPage:
      main: "index.html"
      login: "login.html"
      architecture: "enterprise_architecture_2027.html"
      mcparchitecture: "servicenow_mcp_architecture_2027.html"
  
  runtime:
    type: "ES6 Modules"
    packageJson: "type: module"
    syntax: "import/export"
    
    features:
      - "Tree shaking"
      - "Code splitting"
      - "Dynamic imports"
      - "Top-level await"
  
  backend:
    name: "Firebase"
    version: "10.7.1"
    
    services:
      firestore:
        purpose: "Real-time database"
        collections:
          - "tasks (user-scoped)"
          - "categories (user-scoped)"
          - "users (user metadata)"
          - "experiences (scenarios/demos)"
        features:
          - "Real-time listeners (onSnapshot)"
          - "Offline persistence (IndexedDB)"
          - "Security rules (user-scoped data)"
      
      auth:
        purpose: "User authentication"
        methods:
          - "Email/Password"
        features:
          - "Session persistence"
          - "onAuthStateChanged listener"
      
      storage:
        status: "Not currently used"
        future: "For file uploads, images"
  
  dependencies:
    production:
      firebase:
        version: "^10.7.1"
        usage: "Backend (Firestore, Auth)"
        
      canvasConfetti:
        version: "^1.9.4"
        usage: "Celebration animations (task completion)"
    
    development:
      playwright:
        version: "^1.57.0"
        usage: "E2E testing"
        
      ghPages:
        version: "^6.3.0"
        usage: "GitHub Pages deployment"
        
      vite:
        version: "^7.3.1"
        usage: "Build tool and dev server"
  
  deployment:
    platform: "GitHub Pages"
    repository: "matthewphipps-coder/ZenTask"
    url: "https://matthewphipps-coder.github.io/LEAP/"
    
    commands:
      build: "npm run build"
      deploy: "npm run deploy (runs build + gh-pages -d dist)"
    
    configuration:
      base: "/BIZ/"
      outDir: "dist/"
      branch: "gh-pages"

knownIssues:
  - id: "BUG-001"
    title: "CSS Architecture Issue - Duplicate Loading"
    severity: "CRITICAL"
    status: "resolved"
    
    description: "CSS files were loaded twice: once via <link> tags in index.html and again via @import in index.css"
    
    impact:
      - "CSS changes didn't apply reliably"
      - "Specificity conflicts"
      - "Unpredictable styling behavior"
      - "Blocked visual improvements"
    
    location:
      indexHtml: "Lines 17-19 (direct <link> tags) - REMOVED"
      indexCss: "@import statements - KEPT"
    
    rootCause: "Legacy <link> tags not removed when migrating to modular CSS"
    
    solution: "Removed duplicate <link> tags from index.html (layout.css, scenario-builder.css), kept single index.css link"
    
    resolution:
      phase: "21.3"
      date: "2026-01-16"
      commit: "2d3148e"
      changes:
        - "Removed line 18: <link rel=\"stylesheet\" href=\"src/core/layout.css?v=1.0\">"
        - "Removed line 19: <link rel=\"stylesheet\" href=\"src/ui/components/scenario-builder.css?v=1.0\">"
        - "Kept line 17: <link rel=\"stylesheet\" href=\"index.css\"> (entry point for @imports)"
      validation: "Tested CSS change application (accent color green → red → green)"
      result: "CSS modifications now apply immediately"
    
    unblocked:
      - "BUG-002 (Card visibility)"
  
  - id: "BUG-002"
    title: "Card Visibility - Low Contrast"
    severity: "MEDIUM"
    status: "blocked"
    
    description: "Task cards are hard to see against gradient background"
    
    impact: "UX issue - reduced readability"
    
    blockedBy: "BUG-001 (CSS must be fixed first)"
    
    plannedFix: "Phase 21 (after CSS architecture fix)"

criticalRulesForAI:
  - rule: "Read firebase.js first"
    reason: "Everything depends on db and auth exports"
    consequence: "If Firebase fails to initialize, entire app breaks"
    
  - rule: "State is king"
    reason: "All data flows through state-manager.js singleton"
    antipattern: "Storing state in DOM or local variables"
    
  - rule: "Follow the Triad"
    reason: "Service/UI/Style separation is mandatory (architectural-standards.yaml)"
    enforcement: "Code will be rejected if it violates Triad pattern"
    
  - rule: "Inject dependencies"
    reason: "Services are pure functions with explicit dependencies"
    pattern: "function(data, state, infrastructure)"
    
  - rule: "CSS order matters"
    reason: "Variables → Layout → Components (base.css must load first)"
    critical: "CSS variables must be defined before use"
    
  - rule: "Firebase is reactive"
    reason: "All changes flow through Firebase onSnapshot listeners"
    antipattern: "Manually updating DOM without going through Firebase"
    
  - rule: "Update ARCHITECTURE.yaml"
    reason: "When adding modules or changing dependencies, update this file"
    location: "This file - keep it current"
    
  - rule: "Never assume infrastructure"
    reason: "Always verify Firebase, APIs, credentials exist (constitution.yaml Rule 5)"
    
  - rule: "Wait for !Proceed"
    reason: "No code changes without explicit authorization (constitution.yaml Rule 3)"

quickReference:
  beforeCoding:
    - "□ Read ARCHITECTURE.yaml (this file)"
    - "□ Read CURRENT_STATE.yaml (current phase and status)"
    - "□ Read architectural-standards.yaml (code rules)"
    - "□ Read AI_ONBOARDING.yaml (quick start)"
    - "□ Understand data flow: Firebase → State → UI"
    - "□ Verify Firebase is initialized (window.db, window.auth)"
  
  addingFeature:
    - "□ Create src/features/[name]/ with service + ui + css"
    - "□ Update state-manager.js with new state"
    - "□ Add Firebase listener in app.js setupListeners()"
    - "□ Import in app.js"
    - "□ Add @import to index.css"
    - "□ Follow Triad pattern (Service/UI/Style)"
    - "□ Update ARCHITECTURE.yaml"
    - "□ Update functionality.yaml"
  
  debugging:
    - "□ Check browser console for CP_* checkpoint logs"
    - "□ Inspect window.state for current state"
    - "□ Verify Firebase connection (window.db, window.auth)"
    - "□ Check CSS load order in DevTools Network tab"
    - "□ Check for Firebase permission errors"
    - "□ Verify onSnapshot listeners are active"
  
  commonMistakes:
    - "❌ Modifying code without reading ARCHITECTURE.yaml"
    - "❌ Adding business logic to UI components"
    - "❌ Adding DOM manipulation to services"
    - "❌ Forgetting to update state-manager.js"
    - "❌ Not following CSS load order"
    - "❌ Fighting the Firebase reactive pattern"
    - "❌ Storing state in DOM or local variables"
    - "❌ Not waiting for !Proceed before coding"
  
  testingLocally:
    - "□ Run npm run dev (Vite dev server)"
    - "□ Open http://localhost:8001"
    - "□ Login with test credentials (SECRETS.md)"
    - "□ Test feature functionality"
    - "□ Check browser console for errors"
    - "□ Verify Firebase writes (check Firestore console)"
    - "□ Test offline behavior (disable network)"
  
  deployment:
    - "□ Test locally first (npm run dev)"
    - "□ Create backup (./backups/LEAP-vX.Y.Z-phase-N-complete)"
    - "□ Commit changes to git"
    - "□ Run npm run build (verify no errors)"
    - "□ Run npm run deploy (pushes to gh-pages branch)"
    - "□ Verify deployment at https://matthewphipps-coder.github.io/LEAP/"

updateProtocol:
  whenToUpdate:
    - "When adding new modules or features"
    - "When changing module dependencies"
    - "When modifying data flow patterns"
    - "When refactoring architecture"
    - "When adding new architectural patterns"
    - "When fixing architectural issues"
  
  whatToUpdate:
    modules: "Add new modules to modules section"
    dependencies: "Update dependency map"
    dataFlow: "Document new data flows"
    extensionPoints: "Add new extension patterns"
    knownIssues: "Update issue status, add new issues"
  
  howToUpdate:
    - "Update relevant section(s)"
    - "Update lastUpdated timestamp"
    - "Commit with message: 'Update ARCHITECTURE.yaml - [what changed]'"
    - "Keep this file in sync with codebase"
  
  principle: "ARCHITECTURE.yaml is the map - keep it accurate or AI agents will get lost"
