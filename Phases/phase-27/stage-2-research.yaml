# =============================================================================
# STAGE 2: RESEARCH - Factory Workflow Overhaul
# =============================================================================

metadata:
  phase: 27
  stage: 2
  stageName: "research"
  created: "2026-01-21T22:48:00Z"
  status: "in-progress"
  previousStage: "Phases/phase-27/stage-1-discovery.yaml"

# =============================================================================
# RESEARCH OBJECTIVES
# =============================================================================

researchObjectives:

  1_folderConsolidation:
    question: "What references exist to FactoryTestRuns and factory files?"
    purpose: "Ensure all cross-references are updated after move"
    tasks:
      - "Find all references to FactoryTestRuns"
      - "Find all references to newfactory-workflow.yaml"
      - "Find all references to factory-review-workflow.yaml"
      - "Find all references to factory templates"
  
  2_deviationTemplate:
    question: "What should deviation-report.yaml contain?"
    purpose: "Design objective deviation format with rule citations"
    tasks:
      - "Review existing comparison template structure"
      - "Define deviation fields (rule, expected, actual, evidence)"
      - "Define human review options (backlog, skip, factory-bug)"
  
  3_onboardingMerge:
    question: "What content should ai_onboard.yaml contain?"
    purpose: "Merge new-agent + session-start into single file"
    tasks:
      - "Compare content of both files"
      - "Identify unique vs duplicate content"
      - "Design merged structure"
  
  4_indexDesign:
    question: "What should FactoryTesting/INDEX.yaml contain?"
    purpose: "Directory index with purpose of each file"
    tasks:
      - "List all files in new structure"
      - "Define purpose for each"
      - "Add cross-references"

# =============================================================================
# FINDINGS
# =============================================================================

findings:

  1_folderReferences:
    status: "complete"
    searched: "2026-01-21T22:49:00Z"
    
    counts:
      FactoryTestRuns: "50+ occurrences"
      newfactory-workflow: "28 occurrences"
      factory-review-workflow: "16 occurrences"
    
    keyFilesToUpdate:
      - file: "LEAP_Governance/INDEX.yaml"
        lines: [32, 33, 43, 44]
        updates: "workflow paths + factoryTestRuns location"
      - file: "constitution.yaml"
        lines: [25, 26]
        updates: "workflow paths in coreDocumentation"
      - file: "ARCHITECTURE.yaml"
        lines: [107]
        updates: "newfactory-workflow path"
      - file: "VISION.yaml"
        lines: [60]
        updates: "factory-review-workflow path"
      - file: "backlog-categories.yaml"
        lines: [45]
        updates: "impactArea path"
      - file: "backlog.yaml"
        occurrences: "30+"
        updates: "source references (historical)"
    
    decision:
      approvedBy: "Matthew Phipps"
      timestamp: "2026-01-21T22:51:38Z"
      approach: |
        - Rename FactoryTestRuns → FactoryTestRuns_ARCHIVE
        - Update backlog.yaml refs to point to archive
        - Create FactoryTesting/ as brand new folder
        - Move workflows + templates to new folder

  2_deviationTemplate:
    status: "pending"
    
  3_onboardingMerge:
    status: "pending"
    note: "new-agent.yaml + session-start.yaml → ai_onboard.yaml"
    
  4_indexDesign:
    status: "pending"

# =============================================================================
# PROPOSED FOLDER STRUCTURE (from research)
# =============================================================================

proposedStructure:
  archive:
    path: "FactoryTestRuns_ARCHIVE/"
    purpose: "Preserve old comparison files unchanged"
    action: "Rename from FactoryTestRuns"
  
  new:
    path: "FactoryTesting/"
    purpose: "Consolidated factory workflow folder"
    subfolders:
      - "INDEX.yaml - Directory index"
      - "workflows/ - initiate-factory.yaml, review-factory.yaml"
      - "templates/ - factory-comparison, demo-output-comparison, deviation-report"
      - "prompts/ - Saved onboarding prompts"
      - "results/comparisons/ - New comparison results"
      - "results/deviations/ - Deviation reports"
      - "guides/ - Inspection checklists"

# =============================================================================
# REMAINING RESEARCH
# =============================================================================

remainingResearch:
  - "Design deviation-report.yaml template structure"
  - "Analyze new-agent.yaml vs session-start.yaml content overlap"
  - "Design FactoryTesting/INDEX.yaml content"

# =============================================================================
# GATE QUESTION
# =============================================================================

gateQuestion:
  stageSummary: |
    Research partially complete:
    - ✅ Folder references mapped (50+ occurrences)
    - ✅ Archive strategy decided (rename to _ARCHIVE)
    - ⏳ Deviation template design pending
    - ⏳ Onboarding merge analysis pending
    - ⏳ Index design pending
  
  question: "Continue research or proceed to Analysis with current findings?"
  requires: "!Proceed"
