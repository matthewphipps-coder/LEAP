metadata:
  type: "stage-artifact"
  phase: "4"
  phaseName: "External Control and Audit"
  stage: 4
  stageName: "design"
  completed: "2026-01-18T14:16:31Z"
  completedBy: "Antigravity"
  nextStage: "implementation"

lifecycle:
  currentStage: "design"
  status: "complete"
  nextStage: "implementation"

humanInterface:
  checkpointRequired: true
  nextCheckpoint: "Executive authorization for implementation (!Proceed for file operations)"
  humanRole: "Review exact changes, authorize implementation"
  context: "CRITICAL GATE - file operations begin after this"

implementationPlan:
  
  change1:
    file: "constitution.yaml"
    action: "Add Rule 15 after Rule 14 (line 718)"
    summary: "Gate Record Immutability rule"
    
    exactContent: |
      - id: 15
        name: "Gate Record Immutability"
        description: "Audit records created at gates cannot be modified after creation"
        addedDate: "2026-01-18"
        source: "Phase 4 - External Control and Audit"
        
        principle:
          statement: "Gate records are truth. Truth cannot be edited."
          rationale: "Audit compliance requires immutable evidence of stage gate decisions"
        
        scope:
          applies:
            - "Stage gate artifacts (stage-N-*.yaml after completion)"
            - "Gate records (gate-N-to-N+1.yaml)"
            - "Phase closure documents"
          doesNotApply:
            - "Working documents before gate completion"
            - "Task tracking artifacts"
            - "In-progress stage artifacts"
        
        enforcement:
          aiMustNot: "Modify any artifact where stageStatus or completed field exists"
          humanMay: "Request corrections via new amendment artifact"
          auditTrail: "Amendments reference original, do not replace"
        
        violation:
          detection: "Git history shows modification of completed artifact"
          consequence: "Audit failure - compromised evidence"
    
    insertAfter: "line 718 (before signoff section)"
    linesAdded: "~30"
  
  change2:
    file: "pulse-protocol.yaml"
    action: "Replace 'routine' and 'critical' with unified 'allTransitions'"
    summary: "All stage transitions require explicit !Proceed"
    location: "lines 226-263"
    
    replaceFrom: |
      approvalMechanisms:
        routine:
          transitions:
            - "discovery → research"
            - "research → analysis"
            - "analysis → design"
            - "implementation → validation"
          
          approval: "Simple confirmation (yes, yep, continue, go ahead, !go)"
          
          examples:
            good:
              - user: "yep"
                ai: "Advancing to research stage..."
              
              - user: "yes, proceed to analysis"
                ai: "Advancing to analysis stage..."
              
              - user: "continue"
                ai: "Advancing to next stage..."
              
              - user: "!go"
                ai: "Advancing to next stage..."
            
            acceptable:
              - user: "go ahead"
                ai: "Advancing to next stage..."
              
              - user: "sounds good"
                ai: "Advancing to next stage..."
            
            notAcceptable:
              - user: "maybe"
                ai: "Unclear approval - please confirm with 'yes' or 'proceed'"
              
              - user: "I think so"
                ai: "Need clear approval - please confirm with 'yes' or 'proceed'"
    
    replaceTo: |
      approvalMechanisms:
        allTransitions:
          rule: "ALL stage transitions require explicit !Proceed"
          addedDate: "2026-01-18"
          source: "Phase 4 - External Control and Audit"
          rationale: "Audit compliance requires explicit authorization at every gate"
          
          transitions:
            - "discovery → research"
            - "research → analysis"
            - "analysis → design"
            - "design → implementation"
            - "implementation → validation"
            - "validation → delivery"
            - "delivery → closure"
            - "closure → next phase"
          
          requirement: "Explicit !Proceed (or 'Proceed')"
          note: "'yep', 'yes', 'continue', 'go ahead' are NOT valid"
          
          examples:
            valid:
              - user: "!Proceed"
                ai: "Authorization received. Advancing to [stage]..."
              
              - user: "Proceed"
                ai: "Authorization received. Advancing to [stage]..."
            
            invalid:
              - user: "yep"
                ai: "Need explicit !Proceed. 'Yep' is not valid for audit compliance."
              
              - user: "yes"
                ai: "Need explicit !Proceed. 'Yes' indicates agreement, not authorization."
              
              - user: "sounds good"
                ai: "Need explicit !Proceed for stage advancement."
              
              - user: "continue"
                ai: "Need explicit !Proceed. Please type 'Proceed' or '!Proceed'."
    
    additionalChanges:
      - "Remove 'critical' subsection (lines 264-263) - now redundant"
      - "Keep specific requirements for validation→delivery and closure gates"
    
    linesChanged: "~40"
  
  change3:
    file: "pulse-protocol.yaml"
    action: "Add gateRecords section"
    summary: "Define audit trail requirements"
    insertLocation: "After stageTransitions section (around line 628)"
    
    exactContent: |
      gateRecords:
        name: "Gate Record System"
        purpose: "Audit trail for external compliance verification"
        addedDate: "2026-01-18"
        source: "Phase 4 - External Control and Audit"
        
        requirement: "Create gate record at each stage transition"
        
        location: "docs/phases/phase-X/gate-records/"
        naming: "gate-stage-N-to-N+1.yaml"
        template: "templates/gate-record-template.yaml"
        
        contents:
          - "Timestamp of transition"
          - "!pulse summary (governance compliance)"
          - "Conversation summary (mutual understanding)"
          - "!Proceed authorization (exact quote)"
          - "Files approved for creation/modification"
        
        immutability:
          rule: "Gate records cannot be modified after creation"
          reference: "constitution.yaml Rule 15"
          enforcement: "AI must not edit files with completed gate records"
        
        workflow:
          - step: 1
            action: "AI completes stage work"
          - step: 2
            action: "AI invokes !pulse (governance check)"
          - step: 3
            action: "AI reports findings and awaits !Proceed"
          - step: 4
            action: "Human provides !Proceed"
          - step: 5
            action: "AI creates gate-record before advancing"
          - step: 6
            action: "AI advances to next stage"
    
    linesAdded: "~40"
  
  change4:
    file: "templates/gate-record-template.yaml"
    action: "CREATE new file"
    summary: "Standard template for gate records"
    
    fullContent: |
      metadata:
        type: "gate-record"
        phase: "[PHASE_NUMBER]"
        phaseName: "[PHASE_NAME]"
        fromStage: "[N]"
        fromStageName: "[STAGE_NAME]"
        toStage: "[N+1]"
        toStageName: "[NEXT_STAGE_NAME]"
        timestamp: "[ISO_TIMESTAMP]"
        createdBy: "Antigravity"
      
      immutability:
        status: "LOCKED"
        rule: "This record cannot be modified after creation (Rule 15)"
        amendments: "Create separate amendment artifact if corrections needed"
      
      pulseCheck:
        invoked: "[TIMESTAMP]"
        constitutionCompliance: "[✅ Compliant / ⚠️ Issues Found]"
        ruleViolations: []
        lessonsFromThisStage: []
      
      conversationSummary:
        humanUnderstands: "[What human confirmed they understand]"
        aiUnderstands: "[What AI confirmed it will do]"
        mutualAgreement: "[Key decisions made together]"
      
      authorization:
        proceedReceived: "[TIMESTAMP]"
        proceedQuote: "[Exact !Proceed text from human]"
        filesApproved:
          - "[File 1 approved for creation/modification]"
          - "[File 2 approved for creation/modification]"
      
      auditMetadata:
        phaseObjective: "[Brief phase goal]"
        stageOutcome: "[What was accomplished in completed stage]"
        nextStageExpectation: "[What will be done in next stage]"
    
    linesAdded: "~45"

successCriteria:
  change1: "Rule 15 appears in constitution.yaml after Rule 14"
  change2: "No 'routine' approval section in pulse-protocol.yaml"
  change3: "gateRecords section exists in pulse-protocol.yaml"
  change4: "templates/gate-record-template.yaml exists and is valid YAML"

rollbackPlan:
  method: "git revert"
  commits: "One commit per file for granular rollback"

stageStatus: "complete"
