# =============================================================================
# STAGE 4: DESIGN - Governance Consolidation
# =============================================================================

metadata:
  phase: 28
  stage: 4
  stageName: "design"
  created: "2026-01-21T23:11:00Z"
  lastUpdated: "2026-01-21T23:24:00Z"
  status: "in-progress"
  previousStage: "docs/phases/phase-28/stage-3-analysis.yaml"

# =============================================================================
# FACTORYTESTING FOLDER STRUCTURE (AGREED)
# =============================================================================

factoryTestingStructure:
  description: "Self-contained folder for factory testing process"
  
  files:
    - file: "INDEX.yaml"
      type: "index"
      purpose: "Directory index explaining each file"
    
    - file: "initiate-factory.yaml"
      type: "workflow"
      purpose: "How to start a factory run (copy GoldSource, generate prompt)"
    
    - file: "review-factory.yaml"
      type: "workflow"
      purpose: "How to run an inspection (locate → use guide → create report)"
    
    - file: "inspection-guide.yaml"
      type: "guide"
      purpose: "What specifically to check (locked files, naming, extensions, stages)"
    
    - file: "deviation-report.yaml"
      type: "template"
      purpose: "Where to record findings (rule, expected, actual, evidence)"
  
  folders:
    - folder: "prompts/"
      purpose: "Saved onboarding prompts for repeatability"
    
    - folder: "results/"
      purpose: "Completed deviation reports from inspections"

# =============================================================================
# IMPLEMENTATION PLAN
# =============================================================================

# -----------------------------------------------------------------------------
# PART 1: FOLDER SETUP
# -----------------------------------------------------------------------------

part1_folderSetup:

  step1_renameArchive:
    action: "Rename FactoryTestRuns → FactoryTestRuns_ARCHIVE"
    command: "mv FactoryTestRuns FactoryTestRuns_ARCHIVE"
  
  step2_updateBacklogRefs:
    action: "Update backlog.yaml references"
    file: "LEAP_Governance/tracking/backlog.yaml"
    find: "FactoryTestRuns/"
    replace: "FactoryTestRuns_ARCHIVE/"
    expectedChanges: "30+ occurrences"
  
  step3_createFactoryTesting:
    action: "Create FactoryTesting/ structure"
    commands:
      - "mkdir -p FactoryTesting/prompts"
      - "mkdir -p FactoryTesting/results"
  
  step4_moveAndRenameWorkflows:
    action: "Move workflow files to FactoryTesting/"
    moves:
      - from: "LEAP_Governance/newfactory-workflow.yaml"
        to: "FactoryTesting/initiate-factory.yaml"
      - from: "LEAP_Governance/factory-review-workflow.yaml"
        to: "FactoryTesting/review-factory.yaml"
  
  step5_createNewFiles:
    action: "Create new files, delete old templates"
    creates:
      - "FactoryTesting/INDEX.yaml"
      - "FactoryTesting/inspection-guide.yaml"
      - "FactoryTesting/deviation-report.yaml"
    deletes:
      - "LEAP_Governance/templates/factory-comparison.yaml"
      - "LEAP_Governance/templates/demo-output-comparison.yaml"
  
  step6_moveRunsHistory:
    action: "Move factoryRunsCompleted from CURRENT_STATE to FactoryTesting/INDEX.yaml"
    from: "LEAP_Governance/tracking/CURRENT_STATE.yaml (factoryRunsCompleted section)"
    to: "FactoryTesting/INDEX.yaml"
    note: "Workflows (initiate-factory, review-factory) will reference/update this"
  
  step7_updateAllRefs:
    action: "Update ALL files mentioning factory"
    files:
      - file: "LEAP_Governance/INDEX.yaml"
        changes:
          - "newFactory → FactoryTesting/initiate-factory.yaml"
          - "factoryReview → FactoryTesting/review-factory.yaml"
          - "factoryTestRuns location → FactoryTesting/"
      
      - file: "LEAP_Governance/constitution.yaml"
        changes:
          - "line 25 → FactoryTesting/initiate-factory.yaml"
          - "line 26 → FactoryTesting/review-factory.yaml"
      
      - file: "ARCHITECTURE.yaml"
        changes:
          - "line 107 → FactoryTesting/initiate-factory.yaml"
      
      - file: "LEAP_Governance/tracking/VISION.yaml"
        changes:
          - "line 60 → FactoryTesting/review-factory.yaml"
      
      - file: "LEAP_Governance/tracking/backlog-categories.yaml"
        changes:
          - "line 45 impactArea → FactoryTesting/"
      
      - file: "LEAP_Governance/tracking/CURRENT_STATE.yaml"
        changes:
          - "Remove factoryRunsCompleted section (moved to FactoryTesting/INDEX.yaml)"
          - "Add reference: see FactoryTesting/INDEX.yaml for run history"

# -----------------------------------------------------------------------------
# PART 2: FILE MERGES
# -----------------------------------------------------------------------------

part2_fileMerges:

  step8_mergePeerReview:
    action: "Merge PEER_REVIEW_CHECKLIST → agent-persona.yaml"
    source: "LEAP_Governance/PEER_REVIEW_CHECKLIST.yaml"
    target: "LEAP_Governance/agent-persona.yaml"
    afterMerge: "Delete PEER_REVIEW_CHECKLIST.yaml"
  
  step9_createOnboardProtocol:
    action: "Create ai-onboard-protocol.yaml from new-agent + session-start"
    sources:
      - "LEAP_Governance/checklists/new-agent.yaml"
      - "LEAP_Governance/checklists/session-start.yaml"
    target: "LEAP_Governance/ai-onboard-protocol.yaml"
    type: "protocol (like bump-protocol, rrmd-protocol)"
    afterMerge: "Delete new-agent.yaml and session-start.yaml"
  
  step10_finalRefUpdates:
    action: "Update INDEX.yaml for merged/moved files"

# =============================================================================
# GATE
# =============================================================================

gate:
  question: "Design acceptable? Ready for Implementation?"
  requires: "!Proceed"
