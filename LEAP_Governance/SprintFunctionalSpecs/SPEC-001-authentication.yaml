# =============================================================================
# SPRINT FUNCTIONAL SPEC: Authentication System
# =============================================================================
# Source: Old NEXUS LOGIN_CODE_REVIEW.md, FUNCTIONALITY.md
# Purpose: Complete auth specification for GoldSource scaffold enhancement
# =============================================================================

metadata:
  specId: "SPEC-001"
  name: "Authentication System"
  version: "2.0.0"
  created: "2026-01-20"
  lastUpdated: "2026-01-20"
  status: "draft"
  effort: "medium"  # Well-scoped, builds on existing foundation
  
  # Backlog linkage
  backlogId: "LEAP-035"
  targetPhase: null

# =============================================================================
# CURRENT STATE - What already exists in GoldSource scaffold
# =============================================================================

currentState:
  summary: "Basic login/signup works but missing user profiles, password reset, domain validation, and accessibility"
  
  alreadyImplemented:
    - feature: "Login/Signup Toggle"
      location: "login.js toggleMode()"
      status: "✅ Working"
      note: "Switches form mode, updates button text and subtitle"
    
    - feature: "Loading States"
      location: "login.js handleSubmit()"
      status: "✅ Working"
      note: "Button shows 'Signing in...' or 'Creating account...', disabled during submission"
    
    - feature: "Error Code Mapping"
      location: "login.js getErrorMessage()"
      status: "✅ Working"
      note: "Maps 7 Firebase error codes to user-friendly messages"
    
    - feature: "Password Validation"
      location: "login.js lines 76-79"
      status: "✅ Working"
      note: "Checks minimum 6 characters before submission"
    
    - feature: "Auto-redirect if Authenticated"
      location: "login.js lines 46-51"
      status: "✅ Working"
      note: "Uses setupAuthListener to redirect to index.html if already logged in"
    
    - feature: "Firebase Auth integration"
      location: "core/auth-service.js"
      status: "✅ Working"
      note: "login(), signup(), logout() functions exist"
  
  missingFeatures:
    - feature: "User Profile Creation on Signup"
      impact: "No user doc in Firestore - can't store user settings/XP"
      priority: "must-have"
    
    - feature: "Password Reset Flow"
      impact: "Users can't recover accounts"
      priority: "must-have"
    
    - feature: "Domain Validation"
      impact: "Anyone can sign up - no corporate restriction"
      priority: "should-have"
    
    - feature: "ARIA Labels"
      impact: "Screen readers can't navigate form properly"
      priority: "must-have"
    
    - feature: "Forgot Password Link"
      impact: "UI element missing from login.html"
      priority: "must-have"

# =============================================================================
# SCOPE DEFINITION
# =============================================================================

scope:
  problem: |
    GoldSource scaffold login works but:
    1. Signup doesn't create user profile in Firestore
    2. No password reset flow
    3. No domain validation for corporate use
    4. Missing accessibility (ARIA labels)
    5. No "Forgot Password" link in UI
    
  goal: |
    Complete the auth system by adding the missing features.
    Focus on: user profiles, password reset, domain validation, accessibility.
  
  notInScope:
    - Social auth (Google, Microsoft, etc.)
    - Multi-factor authentication
    - Session timeout / forced re-auth
    - Admin user management UI
    - Email verification flow (Firebase handles this)
    - Redesigning the login UI
  
  successCriteria:
    - Signup creates user document in Firestore /users/{uid}
    - "Forgot Password" link works with inline success/error messages
    - Domain validation blocks non-@servicenow.com emails (by default)
    - All form inputs have ARIA labels
    - Error message container has role="alert"

# =============================================================================
# FUNCTIONAL REQUIREMENTS
# =============================================================================

requirements:
  
  functional:
    # --- NEW: User Profile Creation (most important gap) ---
    - id: "FR-001"
      name: "User Profile Creation on Signup"
      description: "Create user document in Firestore when user signs up"
      priority: "must-have"
      currentState: "NOT IMPLEMENTED"
      acceptance: |
        After signup(), create doc in /users/{uid} with:
        - uid: Firebase user ID
        - email: User email
        - displayName: Extracted from email (before @)
        - role: "member"
        - createdAt: serverTimestamp()
        - xp: 0
      implementation: "Add to auth-service.js signup() function"
    
    # --- NEW: Password Reset ---
    - id: "FR-002"
      name: "Forgot Password Link"
      description: "Add 'Forgot Password?' link to login.html"
      priority: "must-have"
      currentState: "NOT IMPLEMENTED"
      acceptance: |
        - Link appears below password field
        - Clicking prompts for email (use existing email field value)
        - Triggers Firebase sendPasswordResetEmail()
      uiDetails:
        linkText: "Forgot Password?"
        linkPosition: "Below password input, right-aligned"
        linkStyle: "var(--text-secondary), underline on hover"
    
    - id: "FR-003"
      name: "Password Reset Success Message"
      description: "Show inline success message after sending reset email"
      priority: "must-have"
      currentState: "NOT IMPLEMENTED"
      acceptance: "Inline message: '✅ Password reset email sent to {email}'"
      uiDetails:
        messageStyle: "Green text/border (success variant of existing error styling)"
        noAlert: "MUST NOT use alert() - use inline styled message"
    
    - id: "FR-004"
      name: "Password Reset Error Handling"
      description: "Handle reset errors with specific messages"
      priority: "must-have"
      currentState: "NOT IMPLEMENTED"
      acceptance: |
        Error messages:
        - auth/user-not-found: "No account found with this email."
        - auth/invalid-email: "Please enter a valid email address."
        - auth/too-many-requests: "Too many attempts. Please try again later."
    
    # --- NEW: Domain Validation ---
    - id: "FR-005"
      name: "Email Domain Validation"
      description: "Restrict signups to @servicenow.com emails by default"
      priority: "should-have"
      currentState: "NOT IMPLEMENTED"
      acceptance: |
        - Default whitelist: ["@servicenow.com"]
        - Configurable in constants.js: ALLOWED_EMAIL_DOMAINS
        - Set to empty array [] to allow any domain
        - Check on signup BEFORE calling Firebase
        - Error: "Please use your @servicenow.com email address."
      implementation: |
        In constants.js:
        export const ALLOWED_EMAIL_DOMAINS = ['@servicenow.com'];
        
        In login.js before signup():
        if (!validateEmailDomain(email)) {
          showError('Please use your @servicenow.com email address.');
          return;
        }
    
    # --- NEW: Accessibility ---
    - id: "FR-006"
      name: "ARIA Labels on Form Inputs"
      description: "Add accessibility attributes to all form elements"
      priority: "must-have"
      currentState: "NOT IMPLEMENTED"
      acceptance: |
        Email input:
        - aria-label="Email address"
        - aria-required="true"
        
        Password input:
        - aria-label="Password"
        - aria-required="true"
        
        Error container:
        - role="alert"
        - aria-live="polite"
      implementation: "HTML attribute changes in login.html"
    
    # --- ALREADY WORKING (no changes needed) ---
    - id: "FR-007"
      name: "Login/Signup Toggle"
      description: "User can switch between login and signup modes"
      priority: "must-have"
      currentState: "ALREADY IMPLEMENTED"
      note: "No changes needed - works correctly in login.js"
    
    - id: "FR-008"
      name: "Loading States"
      description: "Button shows loading text during auth operations"
      priority: "must-have"
      currentState: "ALREADY IMPLEMENTED"
      note: "No changes needed - shows 'Signing in...' / 'Creating account...'"
    
    - id: "FR-009"
      name: "Error Code Mapping"
      description: "Firebase errors mapped to user-friendly messages"
      priority: "must-have"
      currentState: "ALREADY IMPLEMENTED"
      note: "getErrorMessage() handles 7 error codes"
    
    - id: "FR-010"
      name: "Auto-redirect if Authenticated"
      description: "Redirect to dashboard if already logged in"
      priority: "must-have"
      currentState: "ALREADY IMPLEMENTED"
      note: "setupAuthListener handles this"

# =============================================================================
# UI DETAILS - Specific visual/interaction requirements
# =============================================================================

uiDetails:
  
  forgotPasswordLink:
    position: "Below password input, aligned right"
    html: |
      <div class="forgot-password-container">
        <button type="button" id="forgot-btn" class="forgot-link">
          Forgot Password?
        </button>
      </div>
    css: |
      .forgot-password-container {
        text-align: right;
        margin-top: calc(-1 * var(--space-sm));
        margin-bottom: var(--space-sm);
      }
      .forgot-link {
        background: none;
        border: none;
        color: var(--text-secondary);
        font-size: var(--text-sm);
        cursor: pointer;
        text-decoration: underline;
      }
      .forgot-link:hover {
        color: var(--accent-primary);
      }
      .forgot-link:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
  
  successMessage:
    description: "Reuse existing error div but with success styling"
    css: |
      .login-error.success {
        background: rgba(16, 185, 129, 0.1);
        border-color: var(--success, #10b981);
        color: var(--success, #10b981);
      }
    usage: |
      // Show success
      errorDiv.textContent = '✅ Password reset email sent!';
      errorDiv.classList.add('visible', 'success');
      
      // Show error (existing)
      errorDiv.classList.remove('success');
      errorDiv.classList.add('visible');
  
  loadingStateForReset:
    buttonText: "Sending..."
    behavior: |
      forgotBtn.disabled = true;
      forgotBtn.textContent = 'Sending...';
      // After complete:
      forgotBtn.disabled = false;
      forgotBtn.textContent = 'Forgot Password?';

# =============================================================================
# TECHNICAL APPROACH
# =============================================================================

technicalApproach:
  
  affectedFiles:
    modify:
      - file: "login.html"
        changes:
          - "Add ARIA labels to email and password inputs"
          - "Add role='alert' aria-live='polite' to error div"
          - "Add Forgot Password link after password input"
          - "Add CSS for forgot-link and success message styling"
      
      - file: "login.js"
        changes:
          - "Add forgotBtn element reference"
          - "Add password reset handler"
          - "Add domain validation check before signup"
          - "Import sendPasswordResetEmail from Firebase"
      
      - file: "core/auth-service.js"
        changes:
          - "Add user profile creation in signup() function"
          - "Import serverTimestamp from Firestore"
          - "Add createUserProfile() helper function"
      
      - file: "core/constants.js"
        changes:
          - "Add ALLOWED_EMAIL_DOMAINS constant"
    
    new: []
    delete: []
  
  dependencies:
    - "Firebase Auth SDK (already present)"
    - "Firebase Firestore SDK (already present)"
    - "core/firebase.js (LOCKED - do not modify)"
  
  patterns:
    - "AI-First headers on modified files"
    - "MODULE_CONTRACT exports maintained"
    - "No modification of locked files"
  
  risks:
    - risk: "Breaking existing login flow"
      mitigation: "Test login after each change"
    - risk: "Domain validation too restrictive"
      mitigation: "Clear error message, configurable in constants.js"

# =============================================================================
# VERIFICATION PLAN
# =============================================================================

verification:
  
  manualTests:
    - id: "MT-001"
      name: "User Profile Creation"
      description: "Verify signup creates Firestore document"
      steps:
        - "Go to login.html"
        - "Click 'Sign up'"
        - "Enter new @servicenow.com email and password"
        - "Submit"
        - "Open Firebase Console → Firestore → /users collection"
        - "Find document with matching uid"
      expectedResult: "Document exists with uid, email, displayName, role, createdAt, xp"
    
    - id: "MT-002"
      name: "Password Reset Flow"
      description: "Test complete password reset"
      steps:
        - "Go to login.html"
        - "Enter valid email in email field"
        - "Click 'Forgot Password?'"
        - "Observe loading state ('Sending...')"
        - "Observe success message"
        - "Check email inbox"
      expectedResult: "Inline success message shown, email received"
    
    - id: "MT-003"
      name: "Domain Validation"
      description: "Test email domain restriction"
      steps:
        - "Go to login.html"
        - "Click 'Sign up'"
        - "Enter non-@servicenow.com email (e.g., test@gmail.com)"
        - "Submit"
      expectedResult: "Error: 'Please use your @servicenow.com email address.'"
    
    - id: "MT-004"
      name: "ARIA Labels"
      description: "Verify accessibility attributes"
      steps:
        - "Open login.html in browser"
        - "Right-click email input → Inspect"
        - "Check for aria-label attribute"
        - "Check error div for role='alert'"
      expectedResult: "All ARIA attributes present"
  
  browserTests:
    - id: "BT-001"
      name: "No Console Errors"
      steps:
        - "Load login.html"
        - "Open browser console"
        - "Perform login and signup flows"
      expectedResult: "No JavaScript errors"

# =============================================================================
# APPROVAL
# =============================================================================

approval:
  specApprovedBy: null
  specApprovedDate: null
  implementationApprovedBy: null
  implementationApprovedDate: null

# =============================================================================
# NOTES
# =============================================================================

notes:
  extractedFrom:
    - "/Users/matthew.phipps/Documents/AGY_ARCHIVE/NEXUS/NEXUS-v5.3.6-stable/LOGIN_CODE_REVIEW.md"
    - "/Users/matthew.phipps/Documents/AGY_ARCHIVE/NEXUS/NEXUS-v5.3.6-dev-20260112-1748/FUNCTIONALITY.md"
  
  screenshotsAvailable: false
  screenshotsNote: "No login screenshots found in NEXUS archive - generate wireframes during Design stage if needed"
  
  domainValidationDefault: "@servicenow.com"
  domainValidationConfig: "Set ALLOWED_EMAIL_DOMAINS = [] in constants.js to allow any domain"
  
  futureEnhancements:
    - "Social login (Google, Microsoft)"
    - "Email verification requirement"
    - "Remember me checkbox"
    - "Biometric auth (WebAuthn)"
